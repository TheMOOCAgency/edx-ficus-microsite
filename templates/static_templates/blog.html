<%page expression_filter="h"/>
<%! from django.utils.translation import ugettext as _ %>
<%inherit file="../main.html" />

<%block name="pagetitle">Alumni</%block>

<%
import json
import logging
from opaque_keys.edx.keys import CourseKey
from student.models import CourseEnrollment, UserProfile
from openedx.core.djangoapps.user_api.accounts.image_helpers import get_profile_image_urls_for_user
from lms.djangoapps.grades.new.course_grade import CourseGradeFactory
from courseware.courses import get_course_by_id

log = logging.getLogger()

alumni_courses_list = ['course-v1:champagne-mooc+003+003','course-v1:champagne-mooc+004+004']
course_enrollments, first_name, last_name, email, username, city, country, tell_us_more_again, profile_image_url, mention, linkedin = [], [], [], [], [], [], [], [], [], [], []
json_alumni_users = ''
user_is_alumni_registered = False
country_codes = {}
test_list = []

if request.user.is_authenticated():

    with open('/edx/var/edxapp/media/microsite-utils/countries_code.json') as json_file:
        country_codes = json.load(json_file)

    def get_custom_field_value(custom_field, value):
        if value in custom_field:
            if value == 'country':
                code = custom_field[value]
                country_name = code
                for key in country_codes:
                    if code == key['code']:
                        country_name = key['name']
                return country_name
            else:
                return custom_field[value]
        else:
            return 'n/a'
    
    connected_user_custom_field = json.loads(UserProfile.objects.get(user=request.user).custom_field)
    user_is_alumni_registered = get_custom_field_value(connected_user_custom_field, 'alumni_registered')

    for course_id in alumni_courses_list :
        course_key=CourseKey.from_string(course_id)
        course = get_course_by_id(course_key)
        current_course_enrollments = CourseEnrollment.objects.filter(course_id=course_key)
        for _ce in current_course_enrollments:
            is_new = True
            for course in course_enrollments:
                if course.user.email == _ce.user.email:
                    is_new = False
            if is_new:
                course_enrollments.append(_ce)

    for _ce in course_enrollments:
        user = _ce.user

        try:
            custom_field = json.loads(UserProfile.objects.get(user=user).custom_field)
            if 'alumni_registered' in custom_field and (custom_field['alumni_registered'] == 'true' or custom_field['alumni_registered'] == 'True' or custom_field['alumni_registered'] == True):
                test_list.append(get_custom_field_value(custom_field, 'first_name'))
                email.append(user.email)
                username.append(user.username)
                first_name.append(get_custom_field_value(custom_field, 'first_name'))
                last_name.append(get_custom_field_value(custom_field, 'last_name'))
                city.append(get_custom_field_value(custom_field, 'city'))
                country.append(get_custom_field_value(custom_field, 'country'))
                tell_us_more_again.append(get_custom_field_value(custom_field, 'tell_us_more_again'))
                profile_image_url.append(get_profile_image_urls_for_user(user)['large'])
                if get_custom_field_value(custom_field, 'linkedin') != 'n/a':
                    linkedin.append(get_custom_field_value(custom_field, 'linkedin'))
                else:
                    linkedin.append('')                    
        except:
            pass
        
        percent = 0
        try:
            course_grade = CourseGradeFactory().create(user, course)
            percent = course_grade.percent
        except:
            pass
        mention.append(percent)

    if len(email) > 0:
        alumni_users = [{'first_name': f, 'last_name': la, 'email': e, 'username': u, 'city': ci, 'country': co, 'tell_us_more_again': t, 'profile_image_url' : p, 'mention' : m, 'linkedin': li} for f, la, e, u, ci, co, t, p, m, li in zip(first_name, last_name, email, username, city, country, tell_us_more_again, profile_image_url, mention, linkedin)]
        json_alumni_users = json.dumps(alumni_users)
%>

% if request.user.is_authenticated():
    % if user_is_alumni_registered == 'true' or user_is_alumni_registered == 'True' or user_is_alumni_registered == True:
    <script>
        window.props = {}
        window.props.users_list = []
        var json_alumni_texts = $.getJSON("/media/microsite/champagne-mooc/json/alumni_texts.json", function(json) {
            if ('${request.LANGUAGE_CODE}' === "fr") {
                window.props.texts = json.fr
            } else {
                window.props.texts = json.en
            }
            if ('${json_alumni_users}' !== '') {
                window.props.users_list = JSON.parse('${json_alumni_users|n}')
            }
        });    
    </script>

    <!doctype html><html lang="en"><head><meta charset="utf-8"/><link rel="icon" href="/favicon.ico"/><meta name="viewport" content="width=device-width,initial-scale=1"/><meta name="theme-color" content="#000000"/><meta name="description" content="Web site created using create-react-app"/><link rel="apple-touch-icon" href="/logo192.png"/><link rel="manifest" href="/manifest.json"/><title>React App</title><link href="/media/microsite/champagne-mooc/alumni/static/css/main.1b601e14.chunk.css" rel="stylesheet"></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="root"></div></script><script>!function(e){function r(r){for(var n,l,a=r[0],i=r[1],p=r[2],c=0,s=[];c<a.length;c++)l=a[c],Object.prototype.hasOwnProperty.call(o,l)&&o[l]&&s.push(o[l][0]),o[l]=0;for(n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n]);for(f&&f(r);s.length;)s.shift()();return u.push.apply(u,p||[]),t()}function t(){for(var e,r=0;r<u.length;r++){for(var t=u[r],n=!0,a=1;a<t.length;a++){var i=t[a];0!==o[i]&&(n=!1)}n&&(u.splice(r--,1),e=l(l.s=t[0]))}return e}var n={},o={1:0},u=[];function l(r){if(n[r])return n[r].exports;var t=n[r]={i:r,l:!1,exports:{}};return e[r].call(t.exports,t,t.exports,l),t.l=!0,t.exports}l.m=e,l.c=n,l.d=function(e,r,t){l.o(e,r)||Object.defineProperty(e,r,{enumerable:!0,get:t})},l.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},l.t=function(e,r){if(1&r&&(e=l(e)),8&r)return e;if(4&r&&"object"==typeof e&&e&&e.__esModule)return e;var t=Object.create(null);if(l.r(t),Object.defineProperty(t,"default",{enumerable:!0,value:e}),2&r&&"string"!=typeof e)for(var n in e)l.d(t,n,function(r){return e[r]}.bind(null,n));return t},l.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return l.d(r,"a",r),r},l.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},l.p="/";var a=this.webpackJsonpesapce_alumni=this.webpackJsonpesapce_alumni||[],i=a.push.bind(a);a.push=r,a=a.slice();for(var p=0;p<a.length;p++)r(a[p]);var f=i;t()}([])</script><script src="/media/microsite/champagne-mooc/alumni/static/js/2.1cb1d444.chunk.js"></script><script src="/media/microsite/champagne-mooc/alumni/static/js/main.a33d1393.chunk.js"></script></body></html>
    % else :
    <main id="main" aria-label="Content" tabindex="-1">
        <section class="container about">
            <p>Vous n'êtes pas inscrit à l'espace alumni, accès interdit</p>
        </section>
    </main>
    % endif
% else :
<main id="main" aria-label="Content" tabindex="-1">
    <section class="container about">
        <p>Veuillez vous connecter pour accéder à l'espace Alumni</p>
    </section>
</main>
% endif

<style>
    
</style>
