<!-- TMA TIME TRACKING -->
<script src="/media/interface_stat/jquery.idle.js"></script>
<script type="text/javascript">
  var time_spent=0;
  var can_reset_timer=false;

  //Start timer on page ready
  $(document).ready(function(){
    start_timer();
  });


  $(document).idle({
  idle: 900000,
  onIdle: function(){
    console.log('******************* user is in idle ********************')
    time=end_timer();
    send_time(time);
  },

  onActive: function(){
    if(can_reset_timer){
      console.log('******************* user reset timer ********************')
      start_timer();
    }
  },

  onHide: function(){
    console.log('******************* user is in hidden mode ********************')
    time=end_timer();
    send_time(time);
  },

  onShow: function(){
    if(can_reset_timer){
      console.log('******************* user is in show mode ********************')
      start_timer();
    }
  }
});

  //Send timer when user leaves the page
  window.addEventListener('beforeunload', function (e) {
    time=end_timer();
    console.log('******************time*******************')
    send_time(time);
  });


  function start_timer() {
    startTime = new Date();
    can_reset_timer=false;
    console.log("Votre temps de formation est décompté.")
    $('#time-message').html("Votre temps de formation est décompté.");
    $('.recording-dot').addClass('recording-time').removeClass('not-recording-time');
  };

  function end_timer() {
    endTime = new Date();
    var timeDiff = endTime - startTime; //in ms
    // strip the ms
    timeDiff /= 1000;
    // get seconds
    var seconds = Math.round(timeDiff);
    $('#time-message').html("Votre temps de formation n'est plus décompté.");
    $('.recording-dot').removeClass('recording-time').addClass('not-recording-time');
    console.log('Votre temps de formation n\'est plus décompté.');
    console.log('time sent');
    console.log(seconds);
    //reset_timer
    return seconds;
  }

  function get_section(){
    if(window.location.href.indexOf('discussion')>0){
      section="forum";
    }
    else if(window.location.href.indexOf('/courseware/')>0){
      section=window.location.href.split('/courseware/')[1].split('/')[0];
    }
    else{
      section=''
    }
    return section;
  }

  function get_sub_section(){
    if(window.location.href.indexOf('discussion')<0){
      sub_section=window.location.href.split('/courseware/')[1].split('/')[1].replace('/','');
    }
    else{
      sub_section="forum";
    }
    return sub_section;
  }

  function send_time(time){
    section=get_section();
    subsection=get_sub_section();
    console.log('time sent : '+time);
    $.ajax({
      url : '/tma_apps/${str(course.id)}/tma_stats/time_tracker',
      type : 'POST',
      data : {
        'course_section' : section,
        'course_sub_section':subsection,
        'time':time,
      },
      dataType:'json',
      success : function(data) {
        if ('success' in data){
          console.log('can_reset_timer=true')
          can_reset_timer=true;
        }
      }
    });
  }
</script>

<!-- END TMA TIME TRACKING -->
