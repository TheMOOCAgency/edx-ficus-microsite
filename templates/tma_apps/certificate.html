<%page expression_filter="h"/>
<%inherit file="/main.html" />
<%namespace name='static' file='/static_content.html'/>
<%def name="online_help_token()"><% return "courseware" %></%def>
<%!
from django.utils.translation import ugettext as _
from django.conf import settings
from edxnotes.helpers import is_feature_enabled as is_edxnotes_enabled
from openedx.core.djangolib.markup import HTML
from openedx.core.djangolib.js_utils import js_escaped_string, dump_js_escaped_json
from openedx.core.djangoapps.site_configuration import helpers as configuration_helpers
from datetime import datetime, date
import json
from tma_apps.tma_support_functions import tma_verify_access

primary_color = configuration_helpers.get_value('primary_color')
background_url = configuration_helpers.get_value('bg_img')
%>

<%
certificate_config = configuration_helpers.get_value('CERTIFICATE_LAYOUT').get(course_id)
certificate_width = certificate_config['certificate_width']
certificate_height = certificate_config['certificate_height']
name_position_x = certificate_config['name_position_x']
name_position_y = certificate_config['name_position_y']
font_size = certificate_config['font_size']
image_url = certificate_config['certificate_url']
date_position_x = certificate_config['date_position_x']
%>


<%block name="pagetitle">Attestation de réussite</%block>

<script src="https://cdn.jsdelivr.net/npm/promise-polyfill@8/dist/polyfill.min.js"></script>

<!-- COMMON STYLE-->
<style>
  @font-face {
    font-family: 'Oxygen';
    src: url('/media/microsite/gen/fonts/oxygen/Oxygen-Regular.ttf') format('ttf');
    font-weight: normal;
    font-style: normal;
  }
  @font-face {
      font-family: 'Oxygen';
      src: url('/media/microsite/gen/fonts/oxygen/Oxygen-Bold.ttf') format('ttf');
      font-weight: bold;
      font-style: normal;
  }
  h1,h2,h3,h4,h5,p{
    font-family: Oxygen
  }
  p{
    padding:10px
  }
  h4{
    font-size: 1.5rem;
  }
  h3{
    font-size: 1.7rem
  }
  #certificate-wrapper{
    background: white;
  }
  #custom-btn{
    background: ${primary_color};
    border: none;
    box-shadow: none;
    text-shadow: none;
  }
  #internal-border{
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-direction: column;
    text-align: center;
    padding: 20px;
    box-sizing: border-box;
    background: white;
  }
  #certificate-wrapper{
    min-height: calc(100vh - 133px);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  #certificate-container{
    width: 763px;
    height: 515px;
    margin: 0 auto;
    padding: 40px;
    background-size: contain;
    % if grades.get('passed') or tma_verify_access(request.user).is_tma_team():
        % if request.path == '/tma_apps/course-v1:gen+01_02+2021_T1/certificate/render' :
    background-image: url(/media/microsite/gen/certificate/GEN-Attestation_VDEF.png)
        % elif request.path == '/tma_apps/course-v1:gen+2020+01/certificate/render' :
    background-image: url(/media/microsite/gen/certificate/GEN_Attestation_embarquez_vos_apprenants.png)
        % elif request.path == '/tma_apps/course-v1:gen+01+01/certificate/render' :
    background-image: url(/media/microsite/gen/certificate/attestation_evaluez_efficacement.png)
        % elif request.path == '/tma_apps/course-v1:gen+2022+02/certificate/render' :
    background-image: url(/media/microsite/gen/certificate/GEN_Attestation_embarquez_vos_apprenants.png)
        % elif request.path == '/tma_apps/course-v1:GEN+2023+03/certificate/render' :
    background-image: url(/media/microsite/gen/certificate/GEN_Attestation_embarquez_vos_apprenants.png)
        % elif request.path == '/tma_apps/course-v1:gen+2023+01/certificate/render' :
    background-image: url(/media/microsite/gen/certificate/attestation_evaluez_efficacement.png)
        % elif request.path == '/tma_apps/course-v1:gen+2023+02/certificate/render' :
    background-image: url(/media/microsite/gen/certificate/attestation_evaluez_efficacement.png)
        % else :
            % if int(grades['grade']*100) < 70 :
    background-image: url(/media/microsite/gen/certificate/attestation_gen.png);
            % else :
    background-image: url(/media/microsite/gen/certificate/certificat_gen.png);
            %endif
        %endif
    %endif
  }
  #pdf-btn-wrapper{
    padding: 15px
  }
  #certificate-title{
    text-transform: uppercase;
  }
  #noCertificateMessage{
    background: white;
    height: calc(100vh - 133px);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
  }
  #nameDatas{
    position: relative;
% if request.path == '/tma_apps/course-v1:gen+2020+01/certificate/render'  or request.path == '/tma_apps/course-v1:gen+2022+02/certificate/render' or request.path == '/tma_apps/course-v1:GEN+2023+03/certificate/render':
    top: 130px;
    left: 300px;
    color: #000147 !important;
    font-family: "Open Sans";
% elif request.path == '/tma_apps/course-v1:gen+2023+01/certificate/render' or  request.path == '/tma_apps/course-v1:gen+2023+02/certificate/render' :
    top: 243px;
    left: 300px;
    font-family: "Open Sans";
    font-weight: 700;
% else :
    top: 234px;
    left: 274px;
% endif
    color: rgb(56, 185, 181);
  }
  #dateContainer{
    position: relative;
% if request.path == '/tma_apps/course-v1:gen+2020+01/certificate/render' or request.path == '/tma_apps/course-v1:gen+2022+02/certificate/render' or request.path == '/tma_apps/course-v1:GEN+2023+03/certificate/render':
    top: 362px;
    left: 318px;
    font-family: "Open Sans";
% elif request.path == '/tma_apps/course-v1:gen+2023+01/certificate/render' or request.path == '/tma_apps/course-v1:gen+2023+02/certificate/render'  :
    top: 380px;
    left: 313px;
    font-family: "Open Sans";
    font-size: 14px;
% else :
    top: 381px;
    left: 310px;
% endif
    font-size: 0.8em;
  }
</style>

<!-- CUSTOM STYLE -->
<link rel="stylesheet" type="text/css" href="/media/microsite/gen/css/certificate.css" />

% if grades.get('passed') or tma_verify_access(request.user).is_tma_team():

  
  <div id="certificate-wrapper">
    <div id="pdf-btn-wrapper">
      
      % if request.path == '/tma_apps/course-v1:gen+2020+01/certificate/render' or request.path == '/tma_apps/course-v1:gen+2023+02/certificate/render' or request.path == '/tma_apps/course-v1:gen+2023+01/certificate/render' :
      <button id="custom-btn" onclick="generateCertificate()">TELECHARGER PDF</button>
      % else :
      <button id="custom-btn" onclick="CertificateToPdf()">TELECHARGER PDF</button>
      % endif

    </div>
    <div id="certificate-container" class=" certificate-border">
      <h3 id="nameDatas">${first_name} ${last_name}</h3>
      <p id="dateContainer"><span id="dateDeCertificat"></span></p>
    </div>
  </div>


%else:
  <div id="noCertificateMessage">
    <h3>Certificat Non Disponible</h3>
    <p>Vous n'avez pas atteint le score minimal requis pour obtenir votre certificat.</p>
  </div>
%endif

<!-- PDF CREATOR-->
<script 
    src="https://code.jquery.com/jquery-2.2.4.min.js" 
    integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" 
    crossorigin="anonymous">
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.5/jspdf.debug.js"></script>
<script type="text/javascript">

  function CertificateToPdf(){
    html2canvas(document.getElementById("certificate-container"), {
      onrendered : function (canvas){
        var img=canvas.toDataURL("image/png");
        var doc = new jsPDF({orientation: 'landscape'});
        doc.addImage(img, "PNG", 30, 35);
        doc.save("certificat.pdf");
      }
    })
  }
  
  var certificate_date = ''
  $(document).ready(function(){
    if(navigator.userAgent.indexOf("Firefox")<0 && navigator.userAgent.indexOf("Chrome")<0 && navigator.userAgent.indexOf("Safari")<0){
      $('#pdf-btn-wrapper').html("${_('Download PDF : This feature is not available on Internet Explorer. Please use Chrome Mozilla or Safari to get your pdf')}")
    }

    // GET XCERTIFICATE DATE
    var monthNames = [
      "Janvier", "Février", "Mars",
      "Avril", "Mai", "Juin", "Juillet",
      "Août", "Septembre", "Octobre",
      "Novembre", "Décembre"
    ];
    date = new Date();

    var day = date.getDate();
    var monthIndex = date.getMonth();
    var year = date.getFullYear();
    certificate_date = 'le '+ day + ' ' + monthNames[monthIndex] + ' ' + year;

    $('#dateDeCertificat').text(certificate_date)
  })
    
  
  function generateCertificate(){
    $.ajax({
      url: "/tma_apps/${course_id}/certificate/generate_pdf",
      type: "GET",
      data: {
        user_name : "${first_name} ${last_name}",
        certificate_date: certificate_date,
      },
      dataType: 'html', 
      contentType:'application/pdf',
      success : function(data){
        const url = "/tma_apps/${course_id}/certificate/generate_pdf?certificate_date="+certificate_date
        window.open(url);
      },
      error : function(resultat, statut, error){
        console.error(error)
      }
    })
  }

</script>

