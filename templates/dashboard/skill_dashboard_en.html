<%
from openedx.core.djangolib.markup import HTML, Text
from django.core.urlresolvers import reverse
from tma_apps.tma_support_functions import tma_verify_access
import json
%>
<%page args="about_course_description, about_course_video, course_overview, user, enrollment, associated_courses, associated_courses_previous" expression_filter="h"/>
<% 
course_state = user_course_state[str(enrollment.course_id)] 
has_access = tma_verify_access(request.user).hasDigitalQuizAccess()

# BYPASS barometer access rights
has_access = True

#Yoann : get user group value, stored in microsite config in CUSTOM_TMA_REGISTRATION_EMAIL_PATTERNS_ALLOWED object
domainFiliere = Null
domainGroup = Null
company = Null
domainUser = user.email.split('@')[1]

custom_field ={}
try:
  custom_field = json.loads(user.profile.custom_field)
except:
  pass

try:
  cf_company = custom_field["company"]
except:
  cf_company = "not_found"

try:
  cf_country = custom_field["orange_country"]
except:
  cf_country = "not_found"

%>
<script>
  
// DISPLAY ORANGE- MODAL
let cf_company = "${cf_company}"
let cf_country = "${cf_country}"
if (cf_company.toLowerCase() == 'orange' && cf_country == "not_found") {
  let check_cf = setInterval(() => {
    let divis = document.getElementById("company-needed-orange")
    if (divis) {
      divis.style.display = 'flex'
      clearInterval(check_cf)
    }
  }, 100);
}

// UPDATE CF
function update_country_cf() {
  let country = document.getElementById('modal-input').value
  if (country) { 
    var customFields = {
      orange_country: country,
    }
    $.ajax({
      url: '/tma_apps/tma_api/v0/CustomFieldView/',
      type: "POST",
      data: customFields,
      headers: {'X-CSRFToken': $.cookie('csrftoken')},
      dataType: 'json'
    });
    
    let divis = document.getElementById("company-needed-orange")
    divis.style.display = 'none'
  }
}

// Delete input
function delete_input() {
  document.getElementById('modal-input').value = ''
}
</script>
%if (user.first_name == "" and user.last_name == "") and (custom_field.get('first_name','') == "" or custom_field.get('first_name') is None) and (custom_field.get('last_name','') == "" or custom_field.get('last_name') is None):
  <style>
    button.swal2-confirm:hover{
      background-color:#15A6ED !important;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
  <script src="https://cdn.jsdelivr.net/npm/promise-polyfill"></script>
  <script>
    var first_name = "";
    var last_name  = "" ;

    function update_ln_fn(first_name,last_name){
     var customFields = {
       first_name:first_name,
       last_name:last_name,
     }
     $.ajax({
       url: '/tma_apps/tma_api/v0/CustomFieldView/',
       type: "POST",
       data: customFields,
       headers: {'X-CSRFToken': $.cookie('csrftoken')},
       dataType: 'json'
     });
    }

    function retrieve_fn_ln(){
      const { value: fn } = Swal.fire({
        html: '<h3>Welcome</h3><br/>Please enter your firstname so that we can customize your experience.',
        input: 'text',
        inputPlaceholder: 'John',
        allowOutsideClick: false,
        inputValidator: (value) => {
          return new Promise((resolve) => {
            if (value.length > 1) {
              resolve()
            } else {
              resolve('Please enter your firstname')
            }
          })
        }
      }).then((result) => {
         first_name = result.value;
         const { value: ln } = Swal.fire({
           html: '<h3>Thanks!</h3><br/>Please enter your lastname.',
           input: 'text',
           inputPlaceholder: 'Doe',
           allowOutsideClick: false,
           inputValidator: (value) => {
             return new Promise((resolve) => {
               if (value.length > 1) {
                 resolve()
               } else {
                 resolve('Please enter your lastname')
               }
             })
           }
        }).then((result) => {
           last_name = result.value;
           update_ln_fn(first_name,last_name);
        });
      });
    }

    retrieve_fn_ln();
  </script>
%endif


%if course_state!="finished" and course_state!="ongoing":
<script>
  $.get( "/tma_apps/tma_api/v0/email_allowed/" )
    .done(function( data ) {
      var company = undefined;
      var keys = Object.keys(data)
      var domainUser = "${domainUser}"
      for (var i = 0; i < keys.length; i++) {
        var domain = data[keys[i]].domain
        for (var j = 0; j < domain.length; j++) {
          if (domainUser === domain[j]) {
            company = keys[i];
          }
        }
      }
      var urlAPI = '/tma_apps/tma_api/v0/CustomFieldView/';
      var customFields = {company:company}
      if (company) {
        $.post( urlAPI, customFields )
          .done(function( data ) {
            // console.log("company ajouté au custom fields")
          })
          .fail(function() {
            console.log("bug : company pas ajouté au custom fields")
          })
      }
    })
    .fail(function() {
      console.error("[WUL] : Fail to get email_allowed data")
  })
</script>
%endif

<script>

var companyField = undefined
$.ajax({
    url: '/tma_apps/tma_api/v0/CustomFieldView/',
    type: "GET",
    dataType: 'json',
  success: function (res) {
                  companyField = res.company
                  try {
                    if (res.company.toLowerCase() == "edf") {
                      $("a[href='https://learning.netexplodigimapper.com/register?course_id=course-v1%3Adigimapper-ressources%2BEN%2B1&enrollment_action=enroll&next=%2Fcourses%2Fcourse-v1%3Adigimapper-ressources%2BEN%2B1%2Fcourseware%2Ffca645ff40ab4b60993de20bf404fe11%2F6a2f4b9fa472440ea1b491e783286d26%2F']").attr('href', 'https://www.myelectricnetwork.fr:443/web/tousnumeriques/lire-detail/-/asset_publisher/AO6j/content/digimapper')
                    }
                    
                  } catch (error) {
                    console.log(error);
                  }


              }
})

</script>
    
<style>
#main{
  height: 100vh;
  width: 100vw;
  display: flex;
  align-items: center;
  flex-direction: column;
  justify-content: center;
  background-image:url("/media/microsite/digimapper/auto/images/bg_img.jpeg") !important;
  background-size: cover !important;
  position: fixed;
  left:0;
  top:0;
  color: white;
}

.text-center{
  text-align: center
}

.blue-btn:hover, #course_results:hover, #course_continue:hover {
  background-color: #80CFF5 !important;
  border-color: #80CFF5 !important;
}

.deactivated{
  background-color: #808080cf !important;
  color: #5a6c73 !important;
}

.text-center{
  display: flex;
  flex-direction: column;
  align-items: center;
}
.text-info-quiz{
  font-size: 1.1em;
  color: #000;
}
.horizontal-align {
  display: flex;
  justify-content: center;
  align-items: center;
}

/* ORANGE COMPANY MODAL */
#company-needed-orange {
  display: none;
  position: fixed;
  top:0;
  left: 0;
  height: 100%;
  width: 100vw;
  background-color: rgba(0, 0, 0, 0.6);
  z-index: 11;
  overflow-y: hidden;
  justify-content: center;
}
#modal-container p {
  color: #313131;
}
#modal-container {
  background-color: white;
  width: 500px;
  height: 283px;
  margin-bottom: 120px;
}
#modal-title {
  margin: 20px 10px 0 10px;
  font-size: 36px;
  font-weight: 600;
}
#modal-input {
  padding: 10px;
  width: 275px;
}
#modal-button {
  padding: 10px 30px;
  margin: 37px 10px 0 10px;  
  background-color: #80CCF5;
  color: white;
  text-transform: uppercase;
  border-radius: 8px;
  cursor: pointer;
}
#modal-button-2 {
  padding: 10px 30px;
  margin: 37px 10px 0 10px;  
  background-color: grey;
  color: white;
  text-transform: uppercase;
  border-radius: 8px;
  cursor: pointer;
}

</style>
<div class="container">
  
  <div id="company-needed-orange" class="text-center">
    <div id="modal-container" class="text-center">
      <p id="modal-title">Affiliate</p>
      <label for="modal-input">Select your affiliate</label>
      <div>
        <input list="country" id="modal-input" name="modal-input">
        <datalist id="country">
          <option value="Corp MEA">
          <option value="Botswana">
          <option value="Burkina Faso">
          <option value="Cameroon">
          <option value="Central African Republic">
          <option value="Democratic Republic of Congo">
          <option value="Egypt">
          <option value="Guinea">
          <option value="Guinea Bissau">
          <option value="Ivory Coast">
          <option value="Jordan">
          <option value="Liberia">
          <option value="Madagascar">
          <option value="Mali">
          <option value="Morocco">
          <option value="Senegal">
          <option value="Sierra Leone">
          <option value="Tunisia">
        </datalist>
      </div>
      <div class="horizontal-align">
        <div id="modal-button" onclick="update_country_cf()">confirm</div>
        <!-- <div id="modal-button-2" onclick="delete_input()">cancel</div> -->
      </div>
    </div>
  </div>

  <div class="course-block gray-opacity-bg rounded pad-40 mb-20">
    <img src="/media/microsite/digimapper/auto/images/transparent-logo.png" class="course-logo"/>
    %if associated_courses.get('delayed'):
      <p class="text-center">Next evaluation will be available in ${associated_courses.get('delayed')} days.</p>
    %endif
    <div class="text-center">
    %if not has_access:
      <div id="main">
        <h3>Sorry, you do not currently have access <br> to the Digital Survey.</h3>
      </div>
         <!--<p>Contactez <a href="mailto:technical@themoocagency.com">technical@themoocagency.com</a><br/>si vous faites partie du pilote.</p>-->
    %else:
      %if course_state=="finished":
      <a href="${reverse('SkillRadar', args=[str(enrollment.course_id)])}">
        <button class="text-align-center dashboard-btn"  id="course_results">
          <i class="fa fa-play-circle"></i>
          See my results
        </button>
      </a>
      %elif course_state=="ongoing":
      <a href="${reverse('courseware', args=[str(enrollment.course_id)])}">
        <button class="text-align-center dashboard-btn start-course"  id="course_continue">
          <i class="fa fa-play-circle"></i>
          Resume
        </button>
      </a>
      <p class="text-info-quiz">35 questions / 45 minutes</p>
      %else:
      <button class="text-align-center dashboard-btn" id="course_start">
        <i class="fa fa-play-circle"></i>
        Start
        %if associated_courses.get('step_number')>1:
          quiz ${associated_courses.get('step_number')}
        %endif
      </button>
      <p class="text-info-quiz">35 questions / 45 minutes</p>
      %endif
    %endif 
    </div>
    <div class="bottom-buttons mt-20">
      <div class="text-center">
        %if course_state!="finished" :
        <button class="text-align-center blue-btn mr-20 deactivated" disabled>
          Review my answers
        </button>
        %else :
        <a href="${reverse('courseware', args=[str(enrollment.course_id)])}">
          <button class="text-align-center mr-20 blue-btn"  id="see_answers">
            Review my answers
          </button>
        </a>
        %endif
      </div>
      <div class="text-center">
        %if  course_state != "finished" and associated_courses.get('step_number',1)>1:
        <a href="${reverse('SkillRadar', args=[associated_courses_previous])}">
          <button class="sub-btn blue-btn" id="last_score">
            <i class="fa fa-search"></i>
            Consult my previous score
          </button>
        </a>
        %else :
        <button class="text-align-center blue-btn deactivated" disabled>
          Consult my previous score
        </button>
        %endif
      </div>
      <div class="text-center">
        %if associated_courses.get('step_number',1) > 1 or course_state == "finished":
          <a style="color:inherit;" href="https://learning.netexplodigimapper.com/register?course_id=course-v1%3Adigimapper-ressources%2BEN%2B1&enrollment_action=enroll&next=%2Fcourses%2Fcourse-v1%3Adigimapper-ressources%2BEN%2B1%2Fcourseware%2Ffca645ff40ab4b60993de20bf404fe11%2F6a2f4b9fa472440ea1b491e783286d26%2F" target="_blank">
            <button class="sub-btn blue-btn" id="last_score" style="background-color: #FFAA16 !important;">
              Go to learning path
            </button>   
          </a>
        %else :
        <button class="text-align-center blue-btn deactivated" disabled>
          Go to learning path
        </button>
        %endif
      </div>
    </div> 
  </div>    
</div>

