<%
from openedx.core.djangolib.markup import HTML, Text
from django.core.urlresolvers import reverse
from tma_apps.tma_support_functions import tma_verify_access
from openedx.core.djangoapps.site_configuration import helpers as configuration_helpers
%>
<%page args="about_course_description, about_course_video, course_overview, user, enrollment, associated_courses" expression_filter="h"/>
<% 
course_state = user_course_state[str(enrollment.course_id)] 
has_access = tma_verify_access(request.user).hasDigitalQuizAccess()

#Yoann : get user group value, stored in microsite config in CUSTOM_TMA_REGISTRATION_EMAIL_PATTERNS_ALLOWED object
domainFiliere = Null
domainGroup = Null
userGroup = Null
domainUser = user.email.split('@')[1]
%>
<link rel="stylesheet" type="text/css" href="/media/microsite/techready/auto/css/digimap.css" />

%if course_state!="finished" and course_state!="ongoing":
<script>
  $.get( "/tma_apps/tma_api/v0/email_allowed/" )
    .done(function( data ) {
      var userGroup = "unknown"
      var keys = Object.keys(data)
      var domainUser = "${domainUser}"
      for (var i = 0; i < keys.length; i++) {
        var domain = data[keys[i]].domain
        for (var j = 0; j < domain.length; j++) {
          if (domainUser === domain[j]) {
            userGroup = keys[i];
          }
        }
      }
      var urlAPI = '/tma_apps/tma_api/v0/CustomFieldView/';
      var customFields = {userGroup:userGroup}
      console.log(userGroup)
      if (userGroup) {
        console.log("Mode Démarrer")
        $.post( urlAPI, customFields )
          .done(function( data ) {
            console.log("userGroup ajouté au custom fields")
          })
          .fail(function() {
            console.log("bug : userGroup pas ajouté au custom fields")
          })
      }
    })
    .fail(function() {
      console.error("[WUL] : Fail to get email_allowed data")
  })
</script>
%endif

<style>
  #logoData4Manager > img {
    margin-top: 0;
  }
  #logoData4Manager {
    width: 85%;
    display: flex;
    margin: 50px auto auto auto;
    background: none;
    border: none;
    text-align: center;
    padding: 0 10px 0 0;
    justify-content: space-between;
    align-items: center;
  }
  .content_tma {
    min-height: calc(100vh - 181px) !important;
  }
  .header-global .nav-global li a {
    display: none;
  }
  .text-center{
    text-align: center
  }
  .course-block{
    text-align: left;
  }
  .dashboard_profile {
    margin-bottom: 20px;
  }
  .container{
    min-width: 250px;
  }
  .bottom_btn{
    margin: 15px;
  }
/*  .dashboard-btn{
    width: 100%;
  }*/
  .dashboard-btn:hover{
    background-color: rgba(70,124,218,0.8) !important;
  }
  #dashboard_course_content{
    text-align: center;
    padding-right: 49%;
  }
  @media(max-width:1024px) {
    #dashboard_course_content {
      width: calc(100% - 76px);
      margin-left: 23px;
    }
  }
  @media(max-width:673px) {
    .course_show_tma {
      left: calc(100% - 120px);
      bottom: -48px;
      transform: none;
    }
    #dashboard_course_content{
      padding-right: 0px;
    }
    .tma_bottom_course_listing_multi {
      position: relative;
      bottom: 0;
      border-bottom-left-radius: 15px;
      border-bottom-right-radius: 0px;
    }
  }
  @media(max-width:445px) {
    #dashboard_course_content {
      width: calc(100% - 14px);
      margin-left: 7px;
      margin-right: 7px;
    }
  }
</style>

<div id="dashboard_course_content">
  <!-- <div id="white_veil"> -->
    <div id="white_veil" style="height: 320px;
    min-width: 740px; padding: 10px;">
    <div id="logoData4Manager">
      <img src="/media/microsite/techready/auto/images/logo.png" style="width: 270px;"/>
      <div style="height: 75px;border-left: solid 1px black;"></div>
      <img src="/media/microsite/techready/auto/images/Logo_Netexplo_Noir.png" style="width: 125px;"/>
      <div style="height: 75px;border-left: solid 1px black;"></div>
      <img src="/media/microsite/techready/auto/images/Logo_Télécom.png" style="width: 50px;"/>
    </div>
    <!-- <div id="logoData4Manager">
      <img src="/media/microsite/data-ready/images/data-ready_logo.png" width="50" style="width: 500px;"/>
    </div> -->
    <div class="container">
      <div class="course-block gray-opacity-bg rounded pad-40 mb-20">
        <div class="bottom_btn">
          %if course_state=="finished":
          <a href="${reverse('SkillRadar', args=[str(enrollment.course_id)])}">
            <button class="text-align-center dashboard-btn"  id="course_results">
              <i class="fa fa-play-circle"></i>
              See my results
            </button>
          </a>
          %elif course_state=="ongoing":
          <a href="${reverse('courseware', args=[str(enrollment.course_id)])}">
            <button class="text-align-center dashboard-btn start-course"  id="course_continue" onmouseover="this.style.background='#FFFF99'">
              <i class="fa fa-play-circle"></i>
              Resume
            </button>
          </a>
          %elif user.is_active:
          <button class="text-align-center dashboard-btn" id="course_start">
            <i class="fa fa-play-circle"></i>
            Start
            %if associated_courses.get('step_number')>1:
             <!-- L'évaluation ${associated_courses.get('step_number')} -->
            %endif
          </button>
          %endif
        </div>
        <div class="bottom_btn">
          %if course_state!="finished" :
          <!-- <button class="text-align-center white-btn mr-20 dashboard-btn deactivated" disabled>
            Review my answers
          </button> -->
          %else :
          <!-- <a href="${reverse('courseware', args=[str(enrollment.course_id)])}">
            <button class="text-align-center white-btn mr-20 blue-btn dashboard-btn"  id="see_answers">
              <i class="fa fa-play-circle"></i>
              Review my answers
            </button>
          </a> -->
          %endif
        </div>
        <div class="bottom_btn">
          %if user_course_state=="finished" :
          <!-- <a href="${reverse('SkillRadar', args=[str(enrollment.course_id)])}">
            <button class="text-align-center white-btn deactivated dashboard-btn" id="last_score">
              Consult my previous score
            </button>
          </a> -->
          %else :
          <!-- <button class="text-align-center white-btn deactivated dashboard-btn" disabled>
            Consult my previous score
          </button> -->
          %endif
        </div>
      </div>    
    </div>
  </div>    
</div>