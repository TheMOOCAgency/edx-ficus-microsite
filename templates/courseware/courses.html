<%!
  import json
  from django.utils.translation import ugettext as _
  from openedx.core.djangolib.js_utils import dump_js_escaped_json
  from openedx.core.djangoapps.site_configuration import helpers as configuration_helpers
  import branding
  from courseware.courses import get_course_by_id
  from opaque_keys.edx.keys import CourseKey
%>
<%inherit file="../main.html" />
<%
  course_discovery_enabled = settings.FEATURES.get('ENABLE_COURSE_DISCOVERY')
%>

<%namespace name='static' file='../static_content.html'/>

% if course_discovery_enabled:
<%block name="header_extras">
  % for template_name in ["course_card", "filter_bar", "filter", "facet", "facet_option"]:
  <script type="text/template" id="${template_name}-tpl">
      <%static:include path="discovery/${template_name}.underscore" />
  </script>
  % endfor
  <%static:require_module module_name="js/discovery/discovery_factory" class_name="DiscoveryFactory">
    DiscoveryFactory(
      ${course_discovery_meanings | n, dump_js_escaped_json},
      getParameterByName('search_query'),
      "${user_language}",
      "${user_timezone}"
    );
  </%static:require_module>
</%block>
% endif

<%
org_static = static.get_value('domain_prefix')
css = '/media/microsite/{}/auto/css/courses.css'.format(org_static)
courses=branding.get_visible_courses(org=org_static, filter_=none)
%>

<%
primary_color=configuration_helpers.get_value('primary_color')

if(configuration_helpers.get_value('hidden_courses')):
  hidden_courses = configuration_helpers.get_value('hidden_courses') 
else:
  hidden_courses = []

first_list = []
second_list = []
third_list = []
fourth_list = []

for course in courses[:settings.HOMEPAGE_COURSE_MAX]:
  if str(course.id) not in hidden_courses:
    if "Module" in str(course.id):
      third_list.append(course)
    elif "Auto_positionnement" in str(course.id):
      first_list.append(course)
    elif "Partner_" in str(course.id):
      fourth_list.append(course)
    else:
      second_list.append(course)


second_list.sort(key=lambda x: x.id)
third_list.sort(key=lambda x: x.id)
%>

<script>console.log("${courses}")</script>

<style>
  .custom-courses-category{
    font-weight: 900 !important;
    font-size:1.5em;
    margin-bottom:30px;
    text-transform: uppercase;
    width: 100%;
    padding: 10px;
    border-radius: 2px;
    color:${primary_color};
  }
  .white-background{
    background-color: white !important;
  }
  .custom-courses-display{
    display: flex;
    flex-direction: column;
  }
</style>

<%block name="pagetitle">${_("Courses")}</%block>
<link rel="stylesheet" type="text/css" href="${css}" />

<main id="main" aria-label="Content" tabindex="-1">
    <section class="find-courses">
      <section class="courses-container">
        % if course_discovery_enabled:
        <div id="discovery-form" role="search" aria-label="course" class="wrapper-search-context">
          <div id="discovery-message" class="search-status-label"></div>
          <form class="wrapper-search-input">
            <label for="discovery-input" class="sr">${_('Search for a course')}</label>
            <input id="discovery-input" class="discovery-input" placeholder="${_('Search for a course')}" type="text"/>
            <button type="submit" class="button postfix discovery-submit" title="${_('Search')}">
              <span class="icon fa fa-search" aria-hidden="true"></span>
              <div aria-live="polite" aria-relevant="all">
                <div id="loading-indicator" class="loading-spinner hidden">
                  <span class="icon fa fa-spinner fa-spin" aria-hidden="true"></span>
                  <span class="sr">${_('Loading')}</span>
                </div>
              </div>
            </button>
          </form>
        </div>

        <div id="filter-bar" class="filters hide-phone is-collapsed">
        </div>
        % endif

        <section class="courses-container white-background" style="margin-bottom:50px;">
          <section class="highlighted-courses white-background">
        
            % if settings.FEATURES.get('COURSES_ARE_BROWSABLE'):
            <section class="courses" id="course_catalog">
              <h1>Accédez à nos formations en ligne</h1>
              <div class="custom-courses-display">
                <div class="custom-courses-category">Nos packs de formations</div>
                <ul class="courses-listing">
                  %for course in first_list:
                    <li class="courses-listing-item">
                    <%include file="../course.html" args="course=course" />
                    </li>
                  %endfor
                  %for course in second_list:
                    <li class="courses-listing-item">
                    <%include file="../course.html" args="course=course" />
                    </li>
                  %endfor
                </ul>
        
              </div>
            </section>
            % endif
        
          </section>
        </section>
        <section class="courses-container" style="margin-bottom:50px;">
          <section class="highlighted-courses">
        
            % if settings.FEATURES.get('COURSES_ARE_BROWSABLE'):
            <section class="courses">
              <div class="custom-courses-display">
                <div class="custom-courses-category">Nos modules individuels</div>
                <ul class="courses-listing">
                  %for course in third_list:
                    <li class="courses-listing-item">
                    <%include file="../course.html" args="course=course" />
                    </li>
                  %endfor
                </ul>
              </div>
            </section>
            ## in case there are courses that are not shown on the homepage, a 'View all Courses' link should appear
              % if settings.HOMEPAGE_COURSE_MAX and len(courses) > settings.HOMEPAGE_COURSE_MAX:
              <div class="courses-more">
                <a class="courses-more-cta" href="${marketing_link('COURSES')}"> ${_("View all Courses")} </a>
              </div>
              % endif
            % endif
        
          </section>
        </section>
        <section class="courses-container" style="margin-bottom:50px;background-color:#CDD9EF !important">
          <section class="highlighted-courses">
        
            % if settings.FEATURES.get('COURSES_ARE_BROWSABLE'):
            <section class="courses">
              <div class="custom-courses-display">
                <div class="custom-courses-category">Nos modules Partenaires</div>
                <ul class="courses-listing">
                  %for course in fourth_list:
                    <li class="courses-listing-item">
                    <%include file="../course.html" args="course=course" />
                    </li>
                  %endfor
                </ul>
              </div>
            </section>
            % endif
        
          </section>
        </section>
      </section>
    </section>
</main>