<%namespace name='static' file='static_content.html'/>
<%!
import third_party_auth
from third_party_auth import pipeline, provider
from django.utils.translation import ugettext as _
from django_countries import countries
from student.models import UserProfile
from openedx.core.djangoapps.site_configuration import helpers as configuration_helpers
from django_countries import countries
extra_form = configuration_helpers.get_value('FORM_EXTRA', [])
import datetime
from openedx.core.djangolib.js_utils import dump_js_escaped_json, js_escaped_string
%>

<%
#Additional parameters


def getCourseIdValue(parameterValue, parameterName):
  if parameterValue and parameterName:
    for register_field in extra_form:
      if register_field.get("name").lower()==parameterName.lower():
        for option in register_field.get("options"):
          if option.get('value')==parameterValue:
            return option.get('course')

ville = request.GET.get('ville')
of = getCourseIdValue(request.GET.get('organisme'), 'organisme')
dates_formation = request.GET.get('dates_formation')
expert = request.GET.get('expert')
%>



<%def name="myfunc()">
    $url = url($path, ['params' => ['tag' => 'myTag']]);
	$ville  = param('ville');
</%def>


<input type="hidden" name="csrfmiddlewaretoken" value="${ csrf_token }">

<!-- status messages -->
<div role="alert" class="status message">
  <h3 class="message-title">${_("We're sorry, but this version of your browser is not supported. Try again using a different browser or a newer version of your browser.")}</h3>
</div>

<div role="alert" class="status message submission-error" tabindex="-1">
  <h3 class="message-title">${_("The following errors occurred while processing your registration:")} </h3>
  <ul class="message-copy"> </ul>
</div>
<style>
.header-global .nav-courseware li .btn, .header-global .nav-courseware div .btn, .login .form-actions button[type="submit"], .register .form-actions button[type="submit"], .passwordreset .form-actions button[type="submit"], #forgot-password-modal #password-reset .form-actions button[type="submit"], .view-survey .action-primary {
 color: #fff !important;
}
</style>
% if third_party_auth.is_enabled():

  % if not running_pipeline:

  <div class="form-actions form-third-party-auth">

  % for enabled in provider.Registry.displayed_for_login():
    ## Translators: provider_name is the name of an external, third-party user authentication service (like Google or LinkedIn).
    <button type="submit" class="button button-primary button-${enabled.provider_id} register-${enabled.provider_id}" onclick="thirdPartySignin(event, '${pipeline_urls[enabled.provider_id]}');">
      % if enabled.icon_class:
      <span class="icon fa ${enabled.icon_class}" aria-hidden="true"></span>
      % else:
      <span class="icon" aria-hidden="true"><img class="icon-image" src="${enabled.icon_image.url}" alt="${enabled.name} icon" /></span>
      % endif
      ${_('Sign up with {provider_name}').format(provider_name=enabled.name)}
    </button>
  % endfor

  </div>

  <span class="deco-divider">
    ## Developers: this is a sentence fragment, which is usually frowned upon.  The design of the pags uses this fragment to provide an "else" clause underneath a number of choices.  It's OK to leave it.
    ## Translators: this is the last choice of a number of choices of how to log in to the site.
    <span class="copy">${_('or')}</span>
  </span>

  <p class="instructions">
    ${_('Create your own {platform_name} account below').format(platform_name=platform_name)}
    <span class="note">Les champs obligatoires sont notés en <strong class="indicator">gras et avec un astérisque (*).</strong></span>
  </p>


  % else:

  <p class="instructions">
    ## Translators: selected_provider is the name of an external, third-party user authentication service (like Google or LinkedIn).
    ${_("You've successfully signed in with {selected_provider}.").format(selected_provider='<strong>%s</strong>' % selected_provider)}<br />
    ${_("We just need a little more information before you start learning with {platform_name}.").format(platform_name=settings.PLATFORM_NAME)}
  </p>

  % endif

% else:

<p class="instructions">
  ${_("Please complete the following fields to register for an account. ")}<br />
  <span>Les champs obligatoires sont notés en <strong class="indicator">gras et avec un astérisque (*).</strong></span>
</p>
% endif

<div class="group group-form group-form-requiredinformation">
  <h2 class="sr">${_('Required Information')}</h2>

  % if has_extauth_info is UNDEFINED:

  <ol class="list-input">
    <!--
    <li class="field required text" id="field-last_name">
      <label for="last_name">${_('Last Name')}</label>
      <input class="" id="last_name" type="text" name="last_name" value="${email}" placeholder="${_('example: Durand')}" required aria-required="true" />
    </li>
    <li class="field required text" id="field-first_name">
      <label for="first_name">${_('First Name')}</label>
      <input class="" id="first_name" type="text" name="first_name" value="${email}" placeholder="${_('example: Kevin')}" required aria-required="true" />
    </li>
    -->
    % for n in extra_form:
    <li class="field ${n.get('type')} ${'required' if n.get('required') else ''}">
      <div class="field ${n.get('type')}" id="field-${n.get('name')}">
        % if n.get('name') == 'first_name' or n.get('name') == 'last_name':
        <label for="${n.get('name')}">${_(n.get('label'))}</label>
        <input id="${n.get('name')}" type="${n.get('type')}" name="${n.get('name')}" value="" placeholder="${_(n.get('placeholder'))}" aria-describedby="${n.get('name')}-tip" ${'required aria-required="true"' if n.get('required') else ''} />
        % endif
      </div>
    </li>
    % endfor

    <li class="field required text" id="field-email">
      <label for="email">${_('E-mail')}</label>
      <input class="" id="email" type="email" name="email" value="${email}" placeholder="${_('example: username@domain.com')}" required aria-required="true" />
    </li>


    <li class="field required text" id="field-name" style="display:none;">
      <label for="name">${_('Full Name')}</label>
      <input id="name" type="text" name="name" value="${name}" placeholder="${_('example: Jane Doe')}" required aria-required="true" aria-describedby="name-tip" />
      <span class="tip tip-input" id="name-tip">${_("Your legal name, used for any certificates you earn.")}</span>
    </li>

    <li class="field required text" id="field-username">
      <label for="username">${_('Public Username')}</label>
      <input id="username" type="text" name="username" value="${username}" placeholder="JeanDupont" required aria-required="true" aria-describedby="username-tip"/>
      <span class="tip tip-input" id="username-tip">${_('Will be shown in any discussions or forums you participate in')} <strong>(${_('cannot be changed later')})</strong></span>
    </li>

    % if third_party_auth.is_enabled() and running_pipeline:
      <li class="is-disabled field optional password" id="field-password" hidden>
        <label for="password">${_('Password')}</label>
        <input id="password" type="password" name="password" value="" disabled required aria-required="true"/>
      </li>
    % else:
      <li class="field required password" id="field-password" style="margin-bottom: 20px;">
        <label for="password">${_('Password')}</label>
        <input id="password" type="password" name="password" value="" required aria-required="true"  aria-describedby="password-tip"/>
        <span class="tip tip-input" id="password-tip" style="top:auto;left:0;">Le mot de passe doit contenir au moins <strong>8 caractères</strong> dont <strong>1 chiffre</strong> et <strong>1 caractère spécial</strong>.</span>
      </li>
    % endif
  </ol>
  % else:

  <div class="message">
    <h3 class="message-title">${_("Welcome {username}").format(username=extauth_id)}</h3>
    <p class="message-copy">${_("Enter a Public Display Name:")}</p>
  </div>

  <ol class="list-input">

    % if ask_for_email:

    <li class="field required text" id="field-email">
      <label for="email">${_("E-mail")}</label>
      <input class="" id="email" type="email" name="email" value="" placeholder="${_('example: username@domain.com')}" />
    </li>

    % endif

    <li class="field required text" id="field-username">
      <label for="username">${_('Public Display Name')}</label>
      <input id="username" type="text" name="username" value="${extauth_username}" placeholder="${_('example: JaneDoe')}" required aria-required="true" aria-describedby="username-tip" />
      <span class="tip tip-input" id="id="username-tip>${_('Will be shown in any discussions or forums you participate in')} <strong>(${_('cannot be changed later')})</strong></span>
    </li>

    % if ask_for_fullname:

    <li class="field required text" id="field-name">
      <label for="name">${_('Full Name')}</label>
      <input id="name" type="text" name="name" value="" placeholder="$_('example: Jane Doe')}" aria-describedby="name-tip" />
    </li>

    % endif
  </ol>

  % endif
</div>
<!-- EXTRA_FORM GENERATION -->
<div class="group group-form group-form-requiredinformation">
<ol class="list-input">
% for n in extra_form:
  % if n.get('name') != 'first_name' and n.get('name') != 'last_name':
    <li class="field ${n.get('type')} ${'required' if n.get('required') else ''}">
      <div class="field ${n.get('type')}" id="field-${n.get('name')}">
        % if n.get('type') == 'email':
          <label for="${n.get('name')}">${_(n.get('label'))}</label>
          <input id="${n.get('name')}" type="${n.get('type')}" name="${n.get('name')}" value="" placeholder="${_(n.get('placeholder'))}" aria-describedby="${n.get('name')}-tip" ${'required aria-required="true"' if n.get('required') else ''} />
        % elif n.get('type') == 'text':
          <label for="${n.get('name')}">${_(n.get('label'))}</label>
          <input id="${n.get('name')}" type="${n.get('type')}" name="${n.get('name')}" value="" placeholder="${_(n.get('placeholder'))}" aria-describedby="${n.get('name')}-tip" ${'required aria-required="true"' if n.get('required') else ''} />
        % elif n.get('type') == 'select':
          <label for="${n.get('name')}">${_(n.get('label'))}</label>
          <select id="${n.get('name')}" name="${n.get('name')}" ${'required aria-required="true"' if n.get('required') else ''}>
          % if n.get('name') == 'country':
            <option value="" data-isdefault="true">--</option>
            <%
            _countries = list(countries)
            %>
            % for f in _countries:
              <option values="${f[0]}">${f[1]}</option>
            %endfor
          % endif
        % if n.get('name') == 'year_of_birth':
          <option value="" data-isdefault="true">--</option>
	      <%
	      year = datetime.datetime.today().year
	      YEARS = [year - i for i in range(100)]
	      %>
          % for y in YEARS:
	        <option value="${y}">${y}</option>
	      % endfor
        % else:
          % for j in n.get('options'):
            <option value="${j.get('value')}" ${'default aria-default="true"' if j.get('default') else ''}>${j.get('name')}</option>
          %endfor
        % endif
        </select>
    % elif n.get('type') == 'checkbox':
      <input id="${n.get('name')}" type="${n.get('type')}" name="${n.get('name')}" value="true" ${'required aria-required="true"' if n.get('required') else ''}/>
      <label for="${n.get('name')}">${_(n.get('label'))}</label>
    % endif
    </div>
  </li>
  % endif
% endfor
</ol>
</div>
<!-- end extraform generation -->
<div class="group group-form group-form-secondary group-form-personalinformation" style="padding-bottom:0px">
  <h2 class="sr">${_("Additional Personal Information")}</h2>
  <ol class="list-input">
    % if settings.REGISTRATION_EXTRA_FIELDS['city'] != 'hidden':
    <li class="field ${settings.REGISTRATION_EXTRA_FIELDS['city']} text" id="field-city">
      <label for="city">${_('City')}</label>
      <input id="city" type="text" name="city" value="" placeholder="${_('example: New York')}" aria-describedby="city-tip" ${'required aria-required="true"' if settings.REGISTRATION_EXTRA_FIELDS['city'] == 'required' else ''} />
    </li>
    % endif
    % if settings.REGISTRATION_EXTRA_FIELDS['country'] != 'hidden':
    <li class="field-group">
    <div class="field ${settings.REGISTRATION_EXTRA_FIELDS['country']} select" id="field-country">
        <label for="country">${_("Country")}</label>
        <select id="country" name="country" ${'required aria-required="true"' if settings.REGISTRATION_EXTRA_FIELDS['country'] == 'required' else ''}>
          <option value="">--</option>
          %for code, country_name in countries:
          <option value="${code}">${ unicode(country_name) }</option>
          %endfor
        </select>
      </div>
    </li>
    % endif
    % if settings.REGISTRATION_EXTRA_FIELDS['level_of_education'] != 'hidden':
    <li class="field-group field-education-level">
    <div class="field ${settings.REGISTRATION_EXTRA_FIELDS['level_of_education']} select" id="field-education-level">
        <label for="education-level">${_("Highest Level of Education Completed")}</label>
        <select id="education-level" name="level_of_education" ${'required aria-required="true"' if settings.REGISTRATION_EXTRA_FIELDS['level_of_education'] == 'required' else ''}>
          <option value="">--</option>
          %for code, ed_level in UserProfile.LEVEL_OF_EDUCATION_CHOICES:
          <option value="${code}">${_(ed_level)}</option>
          %endfor
        </select>
      </div>
    </li>
    % endif
    % if settings.REGISTRATION_EXTRA_FIELDS['gender'] != 'hidden':
    <li class="field-group field-gender">
      <div class="field ${settings.REGISTRATION_EXTRA_FIELDS['gender']} select" id="field-gender">
        <label for="gender">${_("Gender")}</label>
        <select id="gender" name="gender" ${'required aria-required="true"' if settings.REGISTRATION_EXTRA_FIELDS['gender'] == 'required' else ''}>
          <option value="">--</option>
          %for code, gender in UserProfile.GENDER_CHOICES:
          <option value="${code}">${_(gender)}</option>
          %endfor
        </select>
      </div>
    </li>
    % endif
    % if settings.REGISTRATION_EXTRA_FIELDS['year_of_birth'] != 'hidden':
    <li class="field-group field-yob">
      <div class="field ${settings.REGISTRATION_EXTRA_FIELDS['year_of_birth']} select" id="field-yob">
        <label for="yob">${_("Year of Birth")}</label>
        <select id="yob" name="year_of_birth" ${'required aria-required="true"' if settings.REGISTRATION_EXTRA_FIELDS['year_of_birth'] == 'required' else ''}>
          <option value="">--</option>
          %for year in UserProfile.VALID_YEARS:
          <option value="${year}">${year}</option>
          %endfor
        </select>
      </div>
      % endif
    </li>
  </ol>
</div>

<div class="group group-form group-form-personalinformation2" style="padding-bottom:0px">
  <ol class="list-input">
    % if settings.REGISTRATION_EXTRA_FIELDS['mailing_address'] != 'hidden':
    <li class="field ${settings.REGISTRATION_EXTRA_FIELDS['mailing_address']} text" id="field-address-mailing">
      <label for="address-mailing">${_("Mailing Address")}</label>
      <textarea id="address-mailing" name="mailing_address" value="" ${'required aria-required="true"' if settings.REGISTRATION_EXTRA_FIELDS['mailing_address'] == 'required' else ''}></textarea>
    </li>

    % endif

	<p style="font-size: 12px;">
  GreenFlex est responsable des traitements de vos données réalisés dans le cadre des actions de formation. Les informations recueillies à partir de ce formulaire sont nécessaires pour le traitement de votre inscription aux formations proposées par GreenFlex (pour plus d’information, consultez la page suivante : <a href="https://eur02.safelinks.protection.outlook.com/?url=https%3A%2F%2Finveest.org%2Fformation-financement-efficacite-energetique&data=02%7C01%7Cfaze%40greenflex.com%7Cb2fe8df1b18e44949fea08d7bacfe8ce%7C30935c8be3794f349859bbdc281f47d0%7C1%7C0%7C637183274434929137&sdata=ibktFWnxfa0pRrYoeHBTb6Gj3nuc0GXkjq5B4G88%2Fxs%3D&reserved=0" target="_blank">formation-financement-efficacite-energetique</a>).


  Votre adresse électronique fait également l’objet d’un traitement informatique destiné aux opérations de prospection pour les services de formation proposés par GreenFlex à la suite de votre inscription au e-learning. Vous êtes donc susceptible de recevoir des informations sur ces sujets. Si vous ne souhaitez pas recevoir de sollicitations par email pour les formations GreenFlex ou des services analogues, vous pouvez adresser dès à présent un email au délégué à la protection des données (DPO) dont les coordonnées sont ci-dessous. Les informations vous concernant sont conservées par GreenFlex pendant la durée nécessaire à la finalité du traitement, c'est-à-dire pour la durée des formations, avec une conservation en archivage intermédiaire pour une durée conforme aux règles de prescription applicable. S’agissant de la prospection, vos données sont conservées pendant un délai de trois ans à compter de leur collecte ou à compter du dernier contact de votre part. Conformément à la réglementation applicable, vous êtes informés de l'existence du droit de demander au responsable de traitement, par l'intermédiaire de son DPO dont les coordonnées sont ci-dessous, l'accès à vos données personnelles, la rectification ou l'effacement de celles-ci, ou une limitation du traitement, ou du droit de vous opposer au traitement et du droit à la portabilité de vos données dans les conditions prévues par le règlement UE 2016/679 du 27 avril 2016 relatif à la protection des personnes physiques à l'égard du traitement de données à caractère personnel. Vous êtes également informés de votre droit d'introduire une réclamation auprès de la CNIL. Vous pouvez adresser vos demandes à notre DPO ou par e-mail à l'adresse dpo@greenflex.com ou par la poste : GREENFLEX, DPO, 7 – 11 boulevard Haussmann 75009 Paris, France. <a href="https://inveest.org/politique-de-confidentialite-economies-energie-industrie/" target="_blank">Cliquez ici pour plus d’information</a>
  </p>

    % if settings.REGISTRATION_EXTRA_FIELDS['goals'] != 'hidden':
    <li class="field ${settings.REGISTRATION_EXTRA_FIELDS['goals']} text" id="field-goals">
      <label for="goals">${_("Please share with us your reasons for registering with {platform_name}").format(platform_name=platform_name)}</label>
      <textarea id="goals" name="goals" value="" ${'required aria-required="true"' if settings.REGISTRATION_EXTRA_FIELDS['goals'] == 'required' else ''}></textarea>
    </li>
    % endif
  </ol>
</div>

<div class="group group-form group-form-accountacknowledgements">
  <h2 class="sr">${_("Account Acknowledgements")}</h2>

  <ol class="list-input">
    <li class="field-group">

      % if has_extauth_info is UNDEFINED or ask_for_tos :
      <div class="field required checkbox" id="field-tos">
        <input id="tos-yes" type="checkbox" name="terms_of_service" value="true" required aria-required="true" />
        <label for="tos-yes">${_('I agree to the {link_start}Terms of Service{link_end}').format(
          link_start='<a href="https://inveest.the-mooc-agency.com/tos" target="_blank" class="new-vp" tabindex="-1">'.format(url=marketing_link('TOS')),
          link_end='</a>')}</label>
      </div>
      % endif

      % if settings.REGISTRATION_EXTRA_FIELDS['honor_code'] != 'hidden':
      ## check if we have an Honor Code link in our marketing map
      % if marketing_link('HONOR') and marketing_link('HONOR') != '#':
      <div class="field ${settings.REGISTRATION_EXTRA_FIELDS['honor_code']} checkbox" id="field-honorcode">
        <input id="honorcode-yes" type="checkbox" name="honor_code" value="true" />
        <%
          honor_code_path = marketing_link('HONOR')
        %>
        <label for="honorcode-yes">${_('I agree to the {link_start}Honor Code{link_end}').format(
          link_start='<a href="{url}" class="new-vp" tabindex="-1">'.format(url=honor_code_path),
          link_end='</a>')}</label>
      </div>
      % endif
      % endif
    </li>
  </ol>

</div>

<div class="form-actions">
  <button name="submit" type="submit" id="submit" class="action action-primary action-update register-button"><!--${_('Create My Account')}--></button>
</div>
<style>
#login_link_up {
 margin-top: 10px;
}
#login_link {
 width: 100%;
 height: 43px;
 margin-top: 10px;
 margin-bottom: 10px;
 color: rgba(98,181,207,1);
 font-weight: bold;
 border: none;
}
#login_link:hover,#login_link:focus,#login_link:visited {
 color: rgba(98,181,207,0.8);
 border: none;
}
</style>
<script>
$('#first_name,#last_name').change(function(){
  var first_name = $('#first_name').attr('value');
  var last_name = $('#last_name').attr('value');
  var name = first_name+' '+last_name;
  $('#name').attr('value',name);
})
</script>


<script>
/* TMA SELECTIVE FIELDS */
var controlledFields=[
  {
    name:"organisme",
    value:${dump_js_escaped_json(of) | n, decode.utf8}
  },
  {
    name: "dates_formation",
    value:${dump_js_escaped_json(dates_formation) | n, decode.utf8},
  },
  {
    name:  "ville",
    value:${dump_js_escaped_json(ville) | n, decode.utf8}
  },
  {
    name:  "expert",
    value:${dump_js_escaped_json(expert) | n, decode.utf8}
  }
]


function bindMyParamatersInput(){
    for(var i=0;i<controlledFields.length;i++){
        if (controlledFields[i]['value']) {
            var fieldValue = decodeURIComponent(controlledFields[i]['value'])
            var fieldElement = $('#'+controlledFields[i]['name'])
            if(controlledFields[i]['name']==="organisme"){
              paramBindSelect("${request.GET.get('organisme')}") 
            }
            else if(controlledFields[i]['name']==="expert"){
              paramBind(fieldElement,fieldValue)
              $(fieldElement).parent("div").hide();
            }
            else{
              paramBind(fieldElement,fieldValue) 
            }
        }
        else {
          var fieldElement = $('#'+controlledFields[i]['name']);
          $(fieldElement).parent("div").hide();
        }
    }
}

function paramBind(target,value){
  target.val(value).prop("readonly", true).css("background","#e8e8e8")
}


function paramBindSelect(value){

$("#organisme option:selected").removeAttr("selected");
$('#organisme option[value=Greenflex]').attr('selected', 'selected');
$("#organisme option[value='"+value +"']").attr('selected', 'selected');
$("#organisme").val(value).prop('readonly', true).css("background","#e8e8e8")

}


bindMyParamatersInput()



$("#myselect option[valueR = value]").attr('selected', 'selected');

</script>
<div class="form-actions" id="login_link_up">
% if static.get_value('course_id') is not None:
  <a id="login_link" href="/login?course_id=${static.get_value('course_id')}&enrollment_action=enroll">${_("Already have an account?")}</a>
% else:
  <a id="login_link" href="/login">${_("Already have an account?")}</a>
% endif
</div>
