<%page expression_filter="h"/>
<%inherit file="main.html" />
<%def name="online_help_token()"><% return "learnerdashboard" %></%def>
<%namespace name='static' file='static_content.html'/>
<%!
from django.core.urlresolvers import reverse
from django.utils.translation import ugettext as _
from django.template import RequestContext
#import third_party_auth
#from third_party_auth import pipeline
from openedx.core.djangolib.js_utils import dump_js_escaped_json, js_escaped_string
from openedx.core.djangolib.markup import HTML, Text
#GEOFFREY
from courseware.courses import get_course_info_section, get_course_date_blocks
from courseware.courses import get_course_by_id
from openedx.core.djangoapps.user_api.accounts.image_helpers import get_profile_image_urls_for_user
from openedx.core.djangoapps.user_api.preferences.api import get_user_preference
from openedx.core.djangoapps.lang_pref import LANGUAGE_KEY
#from lms.djangoapps.grades.new.course_grade import CourseGradeFactory
from cms.djangoapps.models.settings.course_grading import CourseGradingModel
from xmodule.modulestore.django import modulestore
from course_api.blocks.api import get_blocks
#from discussion_tma.views import get_section_list
import time
from openedx.core.djangoapps.site_configuration import helpers as configuration_helpers

from courseware.courses import get_course_about_section
from tma_apps.tma_support_functions import tma_randomization

from django.core.urlresolvers import reverse
import json
import csv

%>
% if not course_enrollments:
<script>
  window.location.replace("/tma_apps/user_info")
</script>
% endif
<%
cert_name_short = settings.CERT_NAME_SHORT
cert_name_long = settings.CERT_NAME_LONG

org_static = static.get_value('domain_prefix')
css = '/media/microsite/{}/auto/css/dashboard.css'.format(org_static)
css_bis = '/media/microsite/{}/auto/css/dashboard_multi.css'.format(org_static)

profile_image_url = get_profile_image_urls_for_user(user)['large']
get_persisted = ''
is_passed = False
course = ''
score = ''
course_module = ''
course_details = ''
blocks = ''
root = ''
children = ''
course_mono_id = ''
forum_tma = ''
course_finished = 0
course_name = []
for dashboard_index, enrollment in enumerate(course_enrollments):
  course = get_course_by_id(enrollment.course_id)
  if len(course_enrollments) == 1:
    course_tma = str(enrollment.course_id)
    user_tma = user.id
    #forum_tma = get_section_list(request,course_tma,user_tma)
    forum_tma= false
    course_mono_id = enrollment.course_id
    #course_module = modulestore().get_course(enrollment.course_id, depth=0)
    #course_details = course_module._field_data_cache['grading_policy']['GRADER']
  """
  elif len(course_enrollments) > 1:
    get_persisted = CourseGradeFactory().get_persisted(request.user, course)
    if get_persisted is None:
      get_persisted = CourseGradeFactory().create(request.user, course)
    if get_persisted.passed:
      course_finished = course_finished + 1
      course_name.append(enrollment.course_overview.display_name_with_default)
    endif
  endif
  """
endfor

#ASSOCIATED COURSES
from tma_apps.associated_courses.helper import AssociatedCourses


primary_color=configuration_helpers.get_value("primary_color") or "#1d5280"
secondary_color=configuration_helpers.get_value("secondary_color") or "#2e85d1"

user_file = open("/edx/var/edxapp/secret/microsite/psa-netexplo/culture_digitale_export.csv", "rb")
psa_users = csv.DictReader(user_file, delimiter=";")
is_ov = False
authorized_users_usernames=[]
for psa_user in psa_users:
  if psa_user["Uid"].lower() == request.user.username.lower() and  psa_user["struct_org1"].lower() == "ov":
      is_ov = True
      break
  if psa_user["email"].lower() == request.user.email.lower():
      authorized_users_usernames += [request.user.username]

if request.user.username == "P052342":
  is_ov = True

if is_ov:
  from datetime import datetime, timedelta
  from pprint import pformat
  import pytz
  from django.utils import timezone
  if request.user.last_login < timezone.now() - timedelta(seconds=10):
    is_ov = False

test_users=["agathe.raymond-carlo@themoocagency.com"]
if request.user.email in test_users:
  is_ov=True
%>

<%block name="pagetitle">${_("Dashboard")}</%block>
<%block name="bodyclass">view-dashboard is-authenticated</%block>

<%block name="header_extras">
% for template_name in ["donation"]:
<script type="text/template" id="${template_name}-tpl">
  <%static:include path="dashboard/${template_name}.underscore" />
</script>
% endfor

% for template_name in ["dashboard_search_item", "dashboard_search_results", "search_loading", "search_error"]:
<script type="text/template" id="${template_name}-tpl">
    <%static:include path="search/${template_name}.underscore" />
</script>
% endfor
</%block>

<%block name="js_extra">
  <script src="${static.url('js/commerce/credit.js')}"></script>
  <%static:js group='dashboard'/>
  <script type="text/javascript">
    $(document).ready(function() {
      edx.dashboard.legacy.init({
        dashboard: "${reverse('dashboard') | n, js_escaped_string}",
        signInUser: "${reverse('signin_user') | n, js_escaped_string}",
        changeEmailSettings: "${reverse('change_email_settings') | n, js_escaped_string}"
      });
    });
  </script>
  % if settings.FEATURES.get('ENABLE_DASHBOARD_SEARCH'):
    <%static:require_module module_name="js/search/dashboard/dashboard_search_factory" class_name="DashboardSearchFactory">
        DashboardSearchFactory();
    </%static:require_module>
  % endif
  % if redirect_message:
    <%static:require_module module_name="js/views/message_banner" class_name="MessageBannerView">
        var banner = new MessageBannerView({urgency: 'low', type: 'warning'});
        $('#content').prepend(banner.$el);
        banner.showMessage(${redirect_message | n, dump_js_escaped_json})
    </%static:require_module>
  % endif
</%block>
<link rel="stylesheet" type="text/css" href="${css_bis}" />
<div class="dashboard-notifications" tabindex="-1">
    %if message:
        <div class="dashboard-banner">
            ${message | n, decode.utf8}
        </div>
    %endif

    %if enrollment_message:
        <div class="dashboard-banner">
            ${enrollment_message | n,  decode.utf8}
        </div>
    %endif
</div>

<link rel="stylesheet" type="text/css" href="${css}" />

<link rel="stylesheet" href="/media/dashboard/bootstrap/bootstrap.min.css">
<!-- COMMON STYLE-->
<style>
#profile_bottom_multi h3, #dashboard_profile_up{
  width:100%;
}
.dropdown-menu{
  left: auto!important;
}
.dropdown-menu .item{
  padding: .25rem 1.5rem;
}
</style>

<div id="voile"></div>
<div class="content_tma">
  <!-- DASHBOARD MONO QUIZ ORIENTED --------------------------------------------------------------------------------------------------------------------------->
  <%
    authorized_users=['gerald.almeras@mpsa.com','celine.hoinard@mpsa.com','cedric.clement@ext.mpsa.com','christophe.rauturier@mpsa.com','bertrand.leprovost@mpsa.com','anne.fenninger@dsautomobiles.com']
    authorized_users+=['aurelien.croq@themoocagency.com','agathe.raymond-carlo@themoocagency.com','nicola.bonaccorso@themoocagency.com']
    authorized_users+=['vbras@netexplo.org','cortega@netexplo.org','gpernoud@netexplo.org','thappe@netexplo.org','levy@hec.fr','slouradour@netexplo.org','scathelat@netexplo.org','mgoddard@netexplo.org','fsegalen@netexplo.org']
    authorized_users+=['alexandre.berteau@themoocagency.com','clothilde.huvier@themoocagency.com']
    authorized_users+=['de_review1@yopmail.com','de_review2@yopmail.com','de_review3@yopmail.com','en_review1@yopmail.com','en_review2@yopmail.com','en_review3@yopmail.com']
    authorized_users+=['tom.douce@themoocagency.com','dimitri.hoareau@themoocagency.com']
    authorized_users+=['psa_choix_langue_1@yopmail.com','psa_choix_langue_2@yopmail.com','psa_choix_langue_3@yopmail.com','psa_choix_langue_4@yopmail.com']
    #fix 12/08/2022
    authorized_users+=['fernanda.bandeira@stellantis.com','markus.dejung@stellantis.com']

    #Filtrage par username
    authorized_users_usernames += ["MZPCUD03","P052702","J110213","J489942","U188717","U291755","J628437","C022945","J534906","C028462","P063018","J488571","J628083","J589703","P052708","J519947","P927190","U022328","J535054","J612901","J494798","J488740","U083151","U203567","C087292","U023936","U356506","J516127","U164220","U235410","J534553","U228669","U210690","U391017","U328679","U318506","U526640","U505657","U397198","P066764","J509328","J111201","U182112","J563187","J589943","C059882","P927690","J544921","U220268","P964969","J530412","U424768","U335310","C011895","U220398","U164275","J504676","U410849","U228361","J509308","U207926","J431023","J488641","P065826","J128712","U385476","U467971","P052012","CA01890","U180991","P051704","U488191","J564574","U411194","ODZKFJD","U244555","U535037","U182539","U174418","U258226","U216494","J597169","J506129","J539438","U384534","C090286","U509859","U297167","J486072","U352746","U173754","J520730","U372745","U304756","U054908","U062391","U385717","C002453","J123649","P745229","U214023","P065721","J512052","J518675","U125615","J369133","C032214","P052342","J400131","J545654","P927574","U561814","U175546","P756321","U027805","U542310","J612468","U539001","U238915","J527011","J400060","J142204","U421262","U555831","U397922","U551454","U504192","U161516","U084676","J629234","J589571","U238454","U560794","U236127","U248066","U524320","U413686","U150889","U113954","U473562","U542013","P051985","P053654","U517046","U439010","U389693","U104623","U532677","U557148","C068722","J502650","J563179","U538705","U536315","J537618","U099458","J539805","J552237","J103215","C081055","U204981","J510898","U391002","J118658","P722834","U551440","P052789","U396497","U557341","U499313","J507622","C032321","P927653","C036746","C039891","CV15281","U220024","U507604","U205829","J526076","U151579","U390648","C040214","P086082","P525507","P523469","P522831","J626055","P964963","J485763","U209983","J540428","P964807","P052059","P723542","J491121","J561231","U504726","U007279","U560733","J587665","U064663","J504058","U530137","U531215","U403686","U254149","J488582","U552333","J517430","P965002","J549472","U231721","J589688","J601209","J495800","J385995","J567423","U068015","U056945","U467872","J560959","P064840","U217020","U311042"]
    authorized_users_usernames += ["J137592","P761321","C015083","P084402","C013320", "OQZMQ1X"]
    authorized_users_usernames += ["U412455","P067306","J510006","J130806","J604320","U304756","J555906","U388506","P723648","P743577","J595447","J611022"]

    #Autorisation d'accès au 22 mai
    #authorized_users_usernames += ["P052708","U467971","J519947","P927190","P063018","U220024","C032321","C039891","CV15281","J507622","P927653","C036746","P052789","U551440","U204981","C081055","J552237","J537618","U536315","U532677","U517046","P051985","U542013","U236127","U084676","U551454","U542310","U509859","J534906","J128712","U372745","U469739","U467337","U535037","U466920","U164275","U417266","U291755","J495800","U367657","U411194","U384534","U388506","J555906","C013320","C074031","U188717","U328679","U257645","P066764","U410849","U244555","CA01890","P722834","J103215","U538705","C068722","U439010","U113954","J629234","U555831","U421262","J527011","J612468","P756321","J400060","J539805","J509328","J518675","U182112","U203567","J567423","U391017","J504676","J564574","U397922","P523469","C090286","C032214","P933655","U297167","U151579","C087292","U205829","C040214","J526076","U235410","J612901","C028462","U507604","J535054","P052059","P767906","J400131","J110213","P052702","J118658","P052059","J544921","U210690","J589703","U488191","P927574","J509308","U335310","J111201","P065826","U220398","J595447","P743577","P723648","C015083","U173754","U385476","U068015","J628437","U062391","J520730","J604320","J130806","P761321","J545654","J626055","P964807","P052012","P723542","J485763","J431023","P964963","U209983","J491121","J540428","P522831","U258226","C059882","P051820","U424768","P964969","J530412","U352746","J486072","U318506","U207926","U083151","U228361","U216494","J369133","U125615","U214023","C002453","U022328","P086082","J385995","U311042","U217020","P064840","J560959","U467872","U056945","U505657","J589943","J512052","U389693","U150889","U248066","U238454","U161516","J494798","P525507","J488571","C011895","J123649","U385717","U180991","U175546","P051704","P065721","J488641","U397198","J611022","P084402","J137592","U304756","P052342","U396497","U099458","J563179","J502650","U104623","U413686","J589571","U238915","U539001","P745229","J510006","P067306","U412455","J539438","J601209","J589688","U231721","J549472","P965002","J517430","J488582","U254149","U403686","U531215","U530137","J504058","U064663","J587665","U007279","U504726","J561231","J489942","U391002","J510898","P053654","U504192","J142204","U027805","U182539","U499313","U174418","U054908","C038932","P927690","U220268","U228669","J534553","U164220","J516127","U356506","U023936","J488740","ODZKFJD","J563187","C053754","C022945","U390648","J628083","J506129","J597169"]

    #Ajout Autorisation d'accès au 23 mai
    #authorized_users_usernames += ["J094844","J143699","J567572","U105589","U164044","U178072","U217932","U264521","U020746","P256425","U007248","U330625","C016685","J525289","U106922","U317579","J108861","U219435","J513897","U160501","P065769","U115269","P726352","J497245","U415962","J400022","P053250","U379860","U246413","U139293","J550244","J588557","U162047","P750230","P052311","U443673"]

    #Autorisations au 29 dont 23 et 22
    authorized_users_usernames += ["P052708","U467971","J519947","P927190","P063018","U220024","C032321","C039891","CV15281","J507622","P927653","C036746","P052789","U551440","U204981","C081055","J552237","J537618","U536315","U532677","U517046","P051985","U542013","U236127","U084676","U551454","U542310","U509859","J534906","J128712","U372745","J516452","P052174","C065872","C052660","P053197","U469739","U469739","U467337","U535037","U466920","U443673","U164275","U417266","U291755","P067549","J495800","P052311","U162047","J550244","U246413","P053250","U115269","U160501","J513897","U020746","U178072","U105589","U367657","U411194","U384534","U388506","J555906","C013320","C074031","U188717","U328679","J588557","P726352","J108861","U317579","U106922","U330625","J094844","U257645","P066764","U410849","U244555","CA01890","P722834","J103215","U538705","C068722","U439010","U113954","J629234","U555831","U421262","J527011","J612468","P756321","J400060","J539805","P750230","U219435","J525289","C016685","J509328","J518675","U139293","U182112","U203567","J567423","U391017","J504676","J564574","U397922","P523469","C090286","C032214","P933655","U297167","U151579","C087292","U205829","C040214","J526076","U235410","J612901","C028462","U507604","J535054","P052059","P767906","J400131","J110213","P052702","J118658","P052059","J544921","U210690","J589703","U488191","P927574","J509308","U335310","J111201","P065826","U220398","J595447","P743577","P723648","C015083","U173754","U385476","U068015","J609940","P087258","J628437","J601716","J628437","U062391","J520730","J604320","J130806","P761321","J545654","P085364","U062289","U198643","U137000","U035310","U174739","J524379","J626055","P964807","P052012","P723542","J485763","J431023","P964963","U209983","J491121","J540428","P522831","U258226","C059882","P051820","U424768","P964969","J530412","U352746","J486072","U379860","P065769","U007248","U164044","J567572","U318506","U207926","U083151","U228361","U216494","J369133","U125615","U214023","C002453","U022328","P086082","J400022","U415962","J497245","P256425","U264521","U217932","J143699","J385995","U311042","U217020","P064840","J560959","U467872","U056945","U505657","J589943","J512052","U389693","U150889","U248066","U238454","U161516","J494798","P525507","J488571","C011895","J123649","U385717","U180991","U175546","P051704","P065721","J488641","U397198","J611022","P084402","J137592","U304756","P052342","U396497","U099458","J563179","J502650","U104623","U413686","J589571","U238915","U539001","P745229","J510006","P067306","U412455","J539438","J601209","J589688","U231721","J549472","P965002","J517430","J488582","U254149","U403686","U531215","U530137","J504058","U064663","J587665","U007279","U504726","J561231","J489942","U391002","J510898","P053654","U504192","J142204","U027805","U182539","U499313","U174418","U054908","C038932","P927690","U220268","U228669","J534553","U164220","J516127","U356506","U023936","J488740","ODZKFJD","P063420","P744998","P063419","U153336","U424036","U248950","J551167","P964606","P066838","J563187","C053754","U164445","P964780","U331354","C022945","J624004","C022945","U390648","J628083","J506129","J597169"]

    authorized_users_usernames +=['psa_choix_langue_1','psa_choix_langue_2','psa_choix_langue_3','psa_choix_langue_4', 'psa_de_review4', 'digimapper_7F7jH','digimapper_9NZ9y','digimapper_anTNR','digimapper_hZmbb','digimapper_s9ho3','digimapper_YRWGa','psa_test1']
    with open('/edx/var/edxapp/secret/microsite/psa-netexplo/barometer_access_rights.json') as json_file:  
        data = json.load(json_file)

    #fix 12/08/2022 + 08/11
    authorized_users_usernames +=['OLZ4FL9', 'ONZXHTB', 'C992934', 'J548550',"T2846JS","T8790K1","T7444EK","T2464EG","T0054RK","U156442","DF84949"]

    authorized_users_usernames.extend(data['allowed_usernames'])

    authorized_admins=['nathalie.heuze@mpsa.com','laetitia.albenque@peugeot.com','valerie.roch@mpsa.com','cedric.clement@ext.mpsa.com','gerald.almeras@mpsa.com','celine.hoinard@mpsa.com','cedric.clement@ext.mpsa.com','christophe.rauturier@mpsa.com','bertrand.leprovost@mpsa.com','anne.fenninger@dsautomobiles.com','vbras@netexplo.org','cortega@netexplo.org','gpernoud@netexplo.org','thappe@netexplo.org','levy@hec.fr','slouradour@netexplo.org','scathelat@netexplo.org','mgoddard@netexplo.org','fsegalen@netexplo.org']
    authorized_admins+=['aurelien.croq@themoocagency.com','yoann.mroz@themoocagency.com','nicola.bonaccorso@themoocagency.com','alexandre.berteau@themoocagency.com','clothilde.huvier@themoocagency.com','tom.douce@themoocagency.com', 'cyril.adolf@weuplearning.com', 'melanie.zunino@themoocagency.com']
    authorized_admins+=['de_review1@yopmail.com','de_review2@yopmail.com','de_review3@yopmail.com','en_review1@yopmail.com','en_review2@yopmail.com','en_review3@yopmail.com']
    authorized_admins+=['fr_review1@yopmail.com','fr_review2@yopmail.com','fr_review3@yopmail.com']
    authorized_admins+=['psareview_fr1@yopmail.com']
    authorized_admins+=['psa_db_review_de1@yopmail.com']
    authorized_admins+=['psa_de_review3@yopmail.com','testpsa_italien1@yopmail.com','testpsa_italien2@yopmail.com','testpsa2@yopmail.com','testpsa1@yopmail.com','testpsa_italien3@yopmail.com','testpsa_italien4@yopmail.com','testpsa_italien5@yopmail.com']
    authorized_admins+=['psa_en_review3@yopmail.com', 'dimitri.hoareau@themoocagency.com' ]
    authorized_admins+=['netexplo_demo1en@yopmail.com','netexplo_demo2en@yopmail.com','netexplo_demo3en@yopmail.com','netexplo_demo4en@yopmail.com','netexplo_demo5en@yopmail.com','netexplo_demo1fr@yopmail.com','netexplo_demo2fr@yopmail.com','netexplo_demo3fr@yopmail.com','netexplo_demo4fr@yopmail.com','netexplo_demo5fr@yopmail.com']

    #PPROD1 - TEST ACCOUNTS
    authorized_users_usernames.extend(["psaDE","psaEN","psaFR","psa-multiatt-FR","psa-multiatt-DE","psa-multiatt-EN","testItalien"])
    #APP1 - TEST ACCOUNTS
    authorized_users_usernames.extend(["psa_multiattempts_de","psa_multiattempts_fr","psa_multiattempts_en","psa_eval1","psa_eval2", "compte_test_multiatt"])
    #MULTIATTEMPTS TEST ACCOUNTS
    authorized_users_usernames.extend(["GA_eval1","GA_eval2","CH_eval1","CH_eval2","FS_eval1","FS_eval2","psa-test-dtl","psa-test-dtl-fs","psa-test-dtl-ter","131_en"])
  %>
  % if len(course_enrollments) == 1 and tma_randomization(course_enrollments[0].course_id).get_randomization_mode()!='random':
  <%
  course_overview=enrollment.course_overview
  about_course_video=get_course_about_section(request, course, "video")
  about_course_description=get_course_about_section(request, course, "overview")



  
  associated_courses= AssociatedCourses(request.user, str(course.id)).associated_courses_details() or {}
  associated_courses_previous= AssociatedCourses(request.user, str(course.id)).get_previous_course() or {}

  

  %>

  <style>
    .gray-bg{
      background-color: #E2E4E1;
    }
    .pad-25{
      padding: 25px;
    }
    .mb-20{
      margin-bottom: 20px;
    }
    iframe{
      max-width: 100%;
    }
    #course_title{
     font-weight:600;
     margin-bottom:0px;
    }
    #trial_name{
     font-size:1rem;
     color: ${primary_color};
     margin-bottom:20px;
    }
    button, button:hover{
      background-image: none!important;
      box-shadow:none!important;
      text-shadow:none;
    }
    .dashboard-btn{
      background-color:${primary_color} !important;
      border-color:${primary_color} !important;
      font-size: 20px;
      padding: 15px 35px;
      border-radius: 6px;
      text-transform: uppercase;
    }
    #course_start{
      min-width:220px;
      width: auto;
    }
    .dashboard-btn:hover{
      background-color: #2e85d1 !important;
      border-color: #2e85d1 !important;
    }
    .dashboard-btn > i{
      font-size: 25px !important
    }
    .mt-20{
      margin-top: 20px;
    }
    .sub-btn{
      min-height: 60px;
      background-color:gray;
      border-color: gray;
      border-radius: 6px;
    }
    .sub-btn:hover{
      background-color:rgba(0,0,0,0.7) !important;
    }
    .sub-btn.deactivated:hover{
    background-color: lightgray !important;
    border-color: lightgray;
    }
    .rounded{
      border-radius: 5px;
    }

    /* Replis partie conseils */
    .overflow-hidden{
      overflow: hidden;
    }
    @media(min-width:1200px) {
      .overflow-hidden {
        max-height: 245px!important;
      }
    }
    @media(min-width: 975px) and (max-width: 1199px)  {
      .overflow-hidden {
        max-height: 262px!important;
      }
    }
    @media(max-width:974px) {
      .overflow-hidden {
        max-height: 355px!important;
      }
    }
    #conseils-btn{
      color: white;
      font-size: 2.333333em!important;
      cursor: pointer;
    }
    .blue-btn{
      background-color: ${primary_color}!important;
    }
    .blue-btn:hover{
      background-color: rgb(46, 133, 209)!important;
    }
  </style>
  <script>
    $('#conseils-btn').live('click', function(){
      $('#conseils').toggleClass('overflow-hidden');
      if($('#conseils').hasClass('overflow-hidden')){
        $('#conseils-btn-wrapper').html('<i id="conseils-btn" class="fa fa-plus-circle"></i>');
      }
      else{
        $('#conseils-btn-wrapper').html('<i id="conseils-btn" class="fa fa-minus-circle"></i>')
      }
    })
  </script>
  <div id="dashboard_course_info">
    <div id="dashboard_course_info_header">
      <h2>${_('News')}</h2>
    </div>
    <div>
      ${HTML(get_course_info_section(request, request.user, course, 'updates'))}
    </div>
    <span id="course_info_next"><a href="/courses/${course_mono_id}/info">${_("More news")}</a></span>
  </div>

    %if course.language=="de":
      <%include file="dashboard/skill_dashboard_de.html" args='about_course_description=about_course_description, about_course_video=about_course_video, course_overview=course_overview, user=user, authorized_users=authorized_users, authorized_users_usernames=authorized_users_usernames,authorized_admins=authorized_admins, enrollment=enrollment, associated_courses=associated_courses, associated_courses_previous=associated_courses_previous,is_ov=is_ov' />
    %elif course.language=="fr":
      <%include file="dashboard/skill_dashboard_fr.html" args='about_course_description=about_course_description, about_course_video=about_course_video, course_overview=course_overview, user=user, authorized_users=authorized_users, authorized_users_usernames=authorized_users_usernames,authorized_admins=authorized_admins, enrollment=enrollment, associated_courses=associated_courses, associated_courses_previous=associated_courses_previous,is_ov=is_ov' />
    %elif course.language=="it":
      <%include file="dashboard/skill_dashboard_it.html" args='about_course_description=about_course_description, about_course_video=about_course_video, course_overview=course_overview, user=user, authorized_users=authorized_users, authorized_users_usernames=authorized_users_usernames,authorized_admins=authorized_admins, enrollment=enrollment, associated_courses=associated_courses, associated_courses_previous=associated_courses_previous,is_ov=is_ov' />
    %else:
      <%include file="dashboard/skill_dashboard_en.html" args='about_course_description=about_course_description, about_course_video=about_course_video, course_overview=course_overview, user=user, authorized_users=authorized_users, authorized_users_usernames=authorized_users_usernames, authorized_admins=authorized_admins, enrollment=enrollment, associated_courses=associated_courses, associated_courses_previous=associated_courses_previous,is_ov=is_ov' />
    %endif

    </div>
  </div>

  <script>
    //Mark course as started
    $('#course_start').on('click', function(){
      course_status_url="${reverse('update_user_course_state', args=[str(enrollment.course_id)])}";
      $.ajax({
      url:course_status_url,
      type:'POST',
      dataType:'json',
      data:{
        course_user_status:"started"
      },
      success:function(data){
        window.location.replace("${reverse('courseware', args=[str(enrollment.course_id)])}")
      }
    });
    })
  </script>

  <!-- FIN DASHBOARD MONO QUIZ ORIENTED ------------------------------------------------------------------------------------------------------------------->


  <!-- DASHBOARD MONO CLASSIC ------------------------------------------------------------------------------------------------------------------->
  % elif len(course_enrollments) == 1:
    %if course.no_grade:
       <style>
        #dashboard_profile_bottom{
          visibility:hidden;
        }
       </style>
    %endif
    <%
    for enrollment in course_enrollments:
        cours_ouv = (enrollment.course_id in show_courseware_links_for) and not (enrollment.course_id in block_courses)
    course_details_len = len(course_details)
    mark = 0
    %>
    <div id="dashboard_profile">
      <div id="profile_button">p r o f i l </div>
      <div class="dashboard_profile" id="dashboard_profile_up">
        <a href="${reverse('learner_profile', kwargs={'username': user.username})}"><img src="${profile_image_url}" /></a>
        <h3>${user.profile.name}</h3>
        <h4>${user.email}</h4>
      </div>

      <!-- block milieu profil -->
      <div class="dashboard_profile" id="dashboard_profile_middle">
        <!-- formation validé -->
        <div id="dashboard_profile_middle_up">
          % if False:
            <img src="${static.url('images/like_couleur.svg')}" class="svg svg_passed"/><span style="margin-left:50px;">${_("Training not validated")}</span>
          % elif cours_ouv:
            <img src="${static.url('images/like_couleur.svg')}" class="svg not_svg_passed"/><span style="margin-left:50px;"><a href="/courses/${course_mono_id}/progress">${_("Training not validated")}</a></span>
          % else:
            <img src="${static.url('images/like_couleur.svg')}" class="svg not_svg_passed"/><span style="margin-left:50px;">${_("Training not validated")}</span>
          % endif
        </div>
        <!-- border middle -->
        <div id="dashboard_profile_middle_middle">
        </div>
        <!-- actif forum -->
        <div id="dashboard_profile_middle_bottom">
          % if forum_tma:
            <img src="${static.url('images/chat_couleur.svg')}" class="svg svg_passed"/><span style="margin-left: 50px;">${_("You are active on the forum")}</span>
          % elif cours_ouv:
            <img src="${static.url('images/chat_couleur.svg')}" class="svg not_svg_passed"/><span style="margin-left:50px;"><a href="/courses/${course_mono_id}/discussion/forum/">${_("Post your first message ! ")}</a></span>
          % else:
            <img src="${static.url('images/chat_couleur.svg')}" class="svg not_svg_passed"/><span style="margin-left:50px;">${_("Post your first message ! ")}</span>
          % endif
        </div>
      </div>

      <!-- block bottom profil -->
      <div class="dashboard_profile" id="dashboard_profile_bottom">
        <!-- note totale -->
        <div id="dashboard_profile_bottom_up">
          <span>${_("Your final grade")}</span><span id="score_tma">${score}%</span>
        </div>
        % for n in course_details:
          <% mark = mark + 1 %>
          <!-- assignement type -->
          <div class="dashboard_profile_bottom_middle">
            <img class="svg" src="${static.url('images/badge_blanc.svg')}" id="badge_${mark}"/><span>${n.get('type')} (
            %if n.get('weight')==0:
            optionnel
            %else:
            ${_('Weight')}: ${int(n.get('weight') * 100)}%
            %endif
            )</span></span><span id="assignment_grade_${mark}">0%</span>
          </div>
          % if mark < course_details_len:
          <!-- border middle -->
          <div class="dashboard_profile_bottom_middle_border"></div>
          % endif
        % endfor
      </div>
    </div>

    <div id="dashboard_course_content">
      % for dashboard_index, enrollment in enumerate(course_enrollments):
        <% show_courseware_link = (enrollment.course_id in show_courseware_links_for) %>
        <% cert_status = cert_statuses.get(enrollment.course_id) %>
        <% can_unenroll = (not cert_status) or cert_status.get('can_unenroll') %>
        <% credit_status = credit_statuses.get(enrollment.course_id) %>
        <% show_email_settings = (enrollment.course_id in show_email_settings_for) %>
        <% course_mode_info = all_course_modes.get(enrollment.course_id) %>
        <% show_refund_option = (enrollment.course_id in show_refund_option_for) %>
        <% is_paid_course = (enrollment.course_id in enrolled_courses_either_paid) %>
        <% is_course_blocked = (enrollment.course_id in block_courses) %>
        <% course_verification_status = verification_status_by_course.get(enrollment.course_id, {}) %>
        <% course_requirements = courses_requirements_not_met.get(enrollment.course_id) %>
        <% related_programs = programs_by_run.get(unicode(enrollment.course_id)) %>
        <%include file='dashboard/_dashboard_course_listing_mono.html' args='course_overview=enrollment.course_overview, enrollment=enrollment, show_courseware_link=show_courseware_link, cert_status=cert_status, can_unenroll=can_unenroll, credit_status=credit_status, show_email_settings=show_email_settings, course_mode_info=course_mode_info, show_refund_option=show_refund_option, is_paid_course=is_paid_course, is_course_blocked=is_course_blocked, verification_status=course_verification_status, course_requirements=course_requirements, social_url=social_url,dashboard_index=dashboard_index, share_settings=share_settings, user=user, related_programs=related_programs, display_course_modes_on_dashboard=display_course_modes_on_dashboard' />
      % endfor
    </div>

    <script type="text/javascript">
      //SCRIPT GRADE SUMMARY
      grade_summary=${dump_js_escaped_json(grade_summary) | n, decode.utf8};
      j=1;
      for (var i = 0; i < grade_summary['section_breakdown'].length; i++){
       if(grade_summary['section_breakdown'][i].prominent){
        grade_to_show = parseInt(grade_summary['section_breakdown'][i].percent*100);
        $("#assignment_grade_"+j.toString()).html(grade_to_show+"%");
        if(grade_to_show>=70){
          $("#badge_"+j.toString()).attr("src","${static.url('images/badge_couleur.svg')}");
        }
        j=j+1;
       }
      }
      $("#score_tma").html(grade_summary['percent']*100+" %");
    </script>

  <!-- FIN DASHBOARD MONO CLASSIC ------------------------------------------------------------------------------------------------------------------->




  <!-- DASHBOARD MULTI ---------------------------------------------------------------------------------------------------------------------->
  % elif len(course_enrollments) > 1:
  <style>
  #dashboard_course_content {
    width: calc(100% - 470px);
    margin-left: 53px;
    margin-right: 53px;
  }
  .dashboard_profile {
    margin-bottom: 20px;
  }
  @media(max-width:1024px) {
    #dashboard_course_content {
      width: calc(100% - 76px);
      margin-left: 23px;
    }
  }
  @media(max-width:673px) {
    .course_show_tma {
      left: calc(100% - 120px);
      bottom: -48px;
      transform: none;
    }
    .tma_bottom_course_listing_multi {
      position: relative;
      bottom: 0;
      border-bottom-left-radius: 15px;
      border-bottom-right-radius: 0px;
    }
  }
  @media(max-width:445px) {
    #dashboard_course_content {
      width: calc(100% - 14px);
      margin-left: 7px;
      margin-right: 7px;
    }
  }
  </style>
  <!-- profil -->
  <div id="dashboard_profile">
    <div id="profile_button">p r o f i l </div>
    <div class="dashboard_profile" id="dashboard_profile_up">
      <a href="${reverse('learner_profile', kwargs={'username': user.username})}"><img src="${profile_image_url}" /></a>
      <h3>${user.profile.name}</h3>
      <h4>${user.email}</h4>
    </div>
    <div class="dashboard_profile" id="profile_bottom_multi">
      % if course_end < 2:
        <h3>${course_end} cours<br>terminé</h3>
      % else:
        <h3>${course_end} cours<br>terminés</h3>
      % endif
      % for n in course_name:
        <div class="course_name_profile_list">
        <img src="${static.url(org_static+'/images/like_couleur.svg')}" class="svg svg_passed"/><span>${n}</span>
        </div>
      % endfor
    </div>
  </div>

  <div id="dashboard_course_content">
  <span id="list_multi_title">
  <h1><span id="span_1">Mes formations</span></h1>
  </span>
  
  <ul id="list_multi">
    % for dashboard_index, enrollment in enumerate(course_enrollments):
      <%include file='dashboard/_dashboard_course_cell_multi.html' args='show_courseware_link = (enrollment.course_id in show_courseware_links_for),is_course_blocked = (enrollment.course_id in block_courses),course_overview=enrollment.course_overview,org_static=org_static, show_email_settings = (enrollment.course_id in show_email_settings_for), enrollment=enrollment, dashboard_index=dashboard_index' />
    % endfor
  </ul>
  </div>


  % else:
  <style>
  .empty-dashboard-message a:hover{
    color: #fff !important;
  }
  </style>
    <div class="empty-dashboard-message">
      <p>${_("You are not enrolled in any courses yet.")}</p>

      % if settings.FEATURES.get('COURSES_ARE_BROWSABLE'):
        <a href="${marketing_link('COURSES')}">
          ${_("Explore courses")}
        </a>

      %endif
  </div>
  % endif
  <!-- FIN DASHBOARD MULTI ---------------------------------------------------------------------------------------------------------------------->
<span style="display:block;clear:left;"></span>
<script>
// SVG ACTION
jQuery('img.svg').each(function(){
    var $img = jQuery(this);
    var imgID = $img.attr('id');
    var imgClass = $img.attr('class');
    var imgURL = $img.attr('src');
    jQuery.get(imgURL, function(data) {
        // Get the SVG tag, ignore the rest
        var $svg = jQuery(data).find('svg');
        // Add replaced image's ID to the new SVG
        if(typeof imgID !== 'undefined') {
            $svg = $svg.attr('id', imgID);
        }
        // Add replaced image's classes to the new SVG
        if(typeof imgClass !== 'undefined') {
            $svg = $svg.attr('class', imgClass+' replaced-svg');
        }
        // Remove any invalid XML tags as per http://validator.w3.org
        $svg = $svg.removeAttr('xmlns:a');
        // Replace image with new SVG
        $img.replaceWith($svg);
    }, 'xml');
});
$('img.svg').show();
// NEW ACTION
$('.updates-article').each(function(){
  var This = $(this);
  var div = '<button class="check_more">${_('View more')}</button>';
  This.append(div);
})
$('#dashboard_profile_middle_up').find('path').initialize(function(){
  $(this).attr('style','');
})
$('.course_name_profile_list').find('path').initialize(function(){
  $(this).attr('style','');
})
function lineHeight(){
  $('.course_name_profile_list').find('span').each(function(){
    $(this).css('line-height','41px');
    var height = $(this).height();
    var lineHeight = parseInt(height) / 41;
    lineHeight = 41 / lineHeight;
    $(this).css('line-height',lineHeight+'px');
    console.log(lineHeight);
  })
}
$('#profile_button').click(function(){
  var num_cours = parseInt('${len(course_enrollments)}');
  var h = $('#dashboard_profile').height();
  var left = $('#dashboard_profile').css('height');
  left = parseInt(left);
  if(left == 30) {
    if(num_cours == 1) {
      var num_l = 40 * $('.dashboard_profile_bottom_middle').length;
      var height = 485+num_l;
      $('#dashboard_profile').animate({"height": height},1300);
    }else{
      $('#dashboard_profile').animate({"height": '400'},1300);
    }
  }else{
    $('#dashboard_profile').animate({"height": '30'},1300);
  }
})
$('.course_cell').click(function(){
  var url = $(this).find('a').attr('href');
  window.open(url,'_self');
})
function title_border_multi() {
  var height = parseInt($('#span_1').width()) * 0.9;
  $('#span_2').css('width',height+'px');
  $('#list_multi').find('.course-title').each(function(){
    var height = parseInt($(this).height()) / 2;
    $(this).attr('style','');
    $(this).css('margin-top','-'+height+'px');
  })
  $('#border_tma_date').attr('style','');
  var tma_date_h = parseInt($('#tma_date').height());
  if(tma_date_h > 20) {
    $('#border_tma_date').hide();
  }

}
function alignH2(){
  var width = $(document).width();
  if(width > 732) {
    $('.multi_course_title').find('h2').each(function(){
      $(this).attr('style','');
      var height = $(this).height();
      height = height / 2;
      $(this).css('margin-top','-'+height+'px');
    })
  }else{
      $(this).find('h2').attr('style','');
  }
}
/* unenroll */

function multi_unenroll() {
  $('.unenroll_multi').click(function(e){
    e.preventDefault();
    var This = $(this);
    var course_id = This.data('course-id');
    $('#unenroll_course_id').attr('value',course_id);
  })
}
$(document).ready(function(){
  lineHeight();
  title_border_multi();
  alignH2();
  multi_unenroll();
  //puceParam();
})
$(window).initialize(function(){
  lineHeight();
  title_border_multi();
  alignH2();
})

</script>
<div id="email-settings-modal" class="modal" aria-hidden="true">
  <div class="inner-wrapper" role="dialog" aria-labelledby="email-settings-title">
    <button class="close-modal">
      <span class="icon fa fa-remove" aria-hidden="true"></span>
      <span class="sr">
        ## Translators: this is a control to allow users to exit out of this modal interface (a menu or piece of UI that takes the full focus of the screen)
        ${_("Close")}
      </span>
    </button>

    <header>
      <h2 id="email-settings-title">
        ${Text(_("Email Settings for {course_number}")).format(course_number=HTML('<span id="email_settings_course_number"></span>'))}
        <span class="sr">,
          ## Translators: this text gives status on if the modal interface (a menu or piece of UI that takes the full focus of the screen) is open or not
          ${_("window open")}
        </span>
      </h2>
      <hr/>
    </header>

    <form id="email_settings_form" method="post">
      <input name="course_id" id="email_settings_course_id" type="hidden" />
      <label>${_("Receive course emails")} <input type="checkbox" id="receive_emails" name="receive_emails" /></label>
      <div class="submit">
        <input type="submit" id="submit" value="${_("Save Settings")}" />
      </div>
    </form>
  </div>
</div>

<div id="unenroll-modal" class="modal unenroll-modal" aria-hidden="true">
  <div class="inner-wrapper" role="dialog" aria-labelledby="unenrollment-modal-title">
    <button class="close-modal">
      <span class="icon fa fa-remove" aria-hidden="true"></span>
      <span class="sr">
        ## Translators: this is a control to allow users to exit out of this modal interface (a menu or piece of UI that takes the full focus of the screen)
        ${_("Close")}
      </span>
    </button>

    <header>
      <h2 id="unenrollment-modal-title">
        <span id='track-info'></span>
        <span id='refund-info'></span>
        <span class="sr">,
          ## Translators: this text gives status on if the modal interface (a menu or piece of UI that takes the full focus of the screen) is open or not
          ${_("window open")}
        </span>
      </h2>
      <hr/>
    </header>
    <div id="unenroll_error" class="modal-form-error"></div>
    <form id="unenroll_form" method="post" data-remote="true" action="${reverse('change_enrollment')}">
      <input name="course_id" id="unenroll_course_id" type="hidden" />
      <input name="enrollment_action" type="hidden" value="unenroll" />
      <div class="submit">
        <input name="submit" type="submit" value="${_("Unenroll")}" />
      </div>
    </form>
  </div>
</div>

  <!-- TMA IMPORT LOADER -->
  <%include file="/tma_apps/loader.html" args="language=get_user_preference(request.user, LANGUAGE_KEY), primary_color=primary_color"/>

  <script>
    $('#course_continue, #course_start, #see_answers, #course_results, #last_score, #skill-bo').live('click', function(){
      $('#overlay').removeClass('hide-loader');
    })
  </script>

